<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UBMAX Motorista</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; overflow-x: hidden; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #16213e, #1a1a2e); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; color: #00d4ff; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .header-btn { background: #ffffff; border: none; color: #333; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        
        /* Status Bar */
        .status-bar { background: #ffffff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .status-left { display: flex; align-items: center; gap: 15px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-dot.disponivel { background: #00ff88; box-shadow: 0 0 10px #00ff88; animation: pulse 2s infinite; }
        .status-dot.em_corrida { background: #ffaa00; box-shadow: 0 0 10px #ffaa00; }
        .status-dot.offline { background: #ff4444; }
        .status-text { font-size: 14px; }
        .status-toggle { background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; color: #333; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .status-toggle.offline { background: linear-gradient(135deg, #00ff88, #00cc6a); }
        .status-toggle.online { background: linear-gradient(135deg, #ff4444, #cc0000); }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* GPS Info */
        .gps-bar { background: #1e1e3f; padding: 10px 20px; display: flex; justify-content: space-between; font-size: 12px; color: #666; }
        .gps-bar.ativo { color: #00ff88; }
        
        /* Cards Dashboard */
        .dashboard { padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .dash-card { background: linear-gradient(135deg, #252542, #1e1e3f); padding: 15px; border-radius: 12px; text-align: center; }
        .dash-card .icon { font-size: 24px; margin-bottom: 5px; }
        .dash-card .value { font-size: 22px; font-weight: bold; color: #00d4ff; }
        .dash-card .label { font-size: 11px; color: #666; margin-top: 3px; }
        .dash-card.green .value { color: #00ff88; }
        .dash-card.orange .value { color: #ffaa00; }
        
        /* Nova Corrida Popup */
        .nova-corrida-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .nova-corrida-overlay.active { display: flex; }
        .nova-corrida-card { background: linear-gradient(135deg, #252542, #1a1a2e); border: 3px solid #00d4ff; border-radius: 20px; width: 100%; max-width: 400px; overflow: hidden; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .corrida-header { background: linear-gradient(135deg, #00d4ff, #0099cc); padding: 15px; text-align: center; }
        .corrida-header h2 { font-size: 18px; margin-bottom: 5px; }
        .corrida-valor { font-size: 32px; font-weight: bold; }
        .corrida-distancia { font-size: 14px; opacity: 0.9; }
        
        .timer-bar { height: 6px; background: #333; }
        .timer-progress { height: 100%; background: linear-gradient(90deg, #00ff88, #ffaa00, #ff4444); transition: width 0.1s linear; }
        
        .corrida-body { padding: 20px; }
        .corrida-info { margin-bottom: 15px; }
        .corrida-info label { font-size: 11px; color: #666; display: block; margin-bottom: 3px; }
        .corrida-info span { font-size: 15px; display: block; }
        .corrida-info .obs { background: #f5f5f5; padding: 8px 12px; border-radius: 8px; margin-top: 5px; font-size: 13px; color: #ffaa00; }
        
        .corrida-cliente { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f5f5f5; border-radius: 12px; margin-bottom: 15px; }
        .cliente-avatar { width: 50px; height: 50px; background: #00d4ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .cliente-info h3 { font-size: 16px; margin-bottom: 3px; }
        .cliente-info span { font-size: 12px; color: #666; }
        
        .corrida-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-aceitar { background: linear-gradient(135deg, #00ff88, #00cc6a); border: none; color: #333; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-recusar { background: linear-gradient(135deg, #ff4444, #cc0000); border: none; color: #333; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        /* Corrida Ativa */
        .corrida-ativa { display: none; padding: 15px; }
        .corrida-ativa.active { display: block; }
        .corrida-ativa-card { background: linear-gradient(135deg, #252542, #1e1e3f); border: 2px solid #00d4ff; border-radius: 15px; overflow: hidden; }
        .corrida-ativa-header { background: #00d4ff; color: #000; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .corrida-ativa-body { padding: 15px; }
        
        .rota-item { display: flex; gap: 15px; margin-bottom: 15px; }
        .rota-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .rota-icon.origem { background: #00ff88; color: #000; }
        .rota-icon.destino { background: #ff4444; color: #333; }
        .rota-content { flex: 1; }
        .rota-content label { font-size: 11px; color: #666; }
        .rota-content p { font-size: 14px; margin-top: 3px; }
        .rota-content .obs { font-size: 12px; color: #ffaa00; margin-top: 5px; }
        
        .corrida-ativa-actions { display: grid; gap: 10px; padding: 15px; }
        .btn-action { padding: 15px; border: none; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-navegar { background: linear-gradient(135deg, #4285f4, #1a73e8); color: #333; }
        .btn-cheguei { background: linear-gradient(135deg, #ffaa00, #ff8800); color: #333; }
        .btn-iniciar { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #333; }
        .btn-finalizar { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #333; }
        .btn-ligar { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #333; }
        .btn-cancelar { background: transparent; border: 2px solid #ff4444; color: #ff4444; }
        
        /* Menu Flutuante */
        .fab-container { display: none; position: fixed; bottom: 80px; right: 20px; z-index: 500; }
        .fab-btn { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; color: #333; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,212,255,0.4); }
        .fab-menu { position: absolute; bottom: 70px; right: 0; background: #ffffff; border-radius: 12px; padding: 10px; display: none; min-width: 200px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .fab-menu.active { display: block; }
        .fab-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .fab-item:hover { background: #f5f5f5; }
        .fab-item span { font-size: 14px; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; display: flex; border-top: 1px solid #333; z-index: 100; }
        .nav-item { flex: 1; padding: 12px 5px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { background: #f5f5f5; color: #00d4ff; }
        .nav-item .icon { font-size: 20px; display: block; }
        .nav-item .label { font-size: 10px; margin-top: 3px; }
        
        /* Pages */
        .page { display: none; padding-bottom: 70px; }
        .page.active { display: block; }
        
        /* Chat */
        .chat-container { height: calc(100vh - 180px); display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; }
        .chat-msg { margin-bottom: 15px; max-width: 80%; }
        .chat-msg.sent { margin-left: auto; }
        .chat-msg .bubble { padding: 12px 15px; border-radius: 15px; font-size: 14px; }
        .chat-msg.received .bubble { background: #ffffff; border-bottom-left-radius: 5px; }
        .chat-msg.sent .bubble { background: #00d4ff; color: #000; border-bottom-right-radius: 5px; }
        .chat-msg .meta { font-size: 11px; color: #666; margin-top: 5px; }
        .chat-msg.sent .meta { text-align: right; }
        .chat-input-container { padding: 15px; background: #ffffff; display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #f5f5f5; border: 1px solid #ddd; border-radius: 25px; padding: 12px 20px; color: #333; font-size: 14px; }
        .chat-send { width: 45px; height: 45px; border-radius: 50%; background: #00d4ff; border: none; color: #000; font-size: 18px; cursor: pointer; }
        
        /* Caixa/Financeiro */
        .financeiro-header { padding: 20px; background: linear-gradient(135deg, #252542, #1e1e3f); text-align: center; }
        .financeiro-saldo { font-size: 36px; font-weight: bold; color: #00ff88; }
        .financeiro-label { font-size: 12px; color: #666; margin-top: 5px; }
        .financeiro-actions { display: flex; gap: 10px; padding: 15px; }
        .fin-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .fin-btn.entrada { background: #00ff88; color: #000; }
        .fin-btn.saida { background: #ff4444; color: #333; }
        .transacoes-list { padding: 15px; }
        .transacao-item { display: flex; justify-content: space-between; padding: 15px; background: #ffffff; border-radius: 10px; margin-bottom: 10px; }
        .transacao-item .valor.positivo { color: #00ff88; }
        .transacao-item .valor.negativo { color: #ff4444; }
        
        /* Relat√≥rios */
        .relatorio-card { background: #ffffff; margin: 15px; border-radius: 12px; padding: 20px; }
        .relatorio-periodo { display: flex; gap: 10px; margin-bottom: 20px; }
        .periodo-btn { flex: 1; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; color: #333; cursor: pointer; }
        .periodo-btn.active { background: #00d4ff; color: #000; border-color: #00d4ff; }
        .relatorio-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .rel-stat { text-align: center; padding: 15px; background: #f5f5f5; border-radius: 10px; }
        .rel-stat .value { font-size: 24px; font-weight: bold; color: #00d4ff; }
        .rel-stat .label { font-size: 12px; color: #666; margin-top: 5px; }
        
        /* Emerg√™ncia */
        .emergencia-list { padding: 15px; }
        .emergencia-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #ffffff; border-radius: 12px; margin-bottom: 10px; }
        .emergencia-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .emergencia-icon.admin { background: #00d4ff; }
        .emergencia-icon.mecanico { background: #ffaa00; }
        .emergencia-icon.guincho { background: #ff4444; }
        .emergencia-icon.borracheiro { background: #9c27b0; }
        .emergencia-info { flex: 1; }
        .emergencia-info h3 { font-size: 16px; }
        .emergencia-info span { font-size: 12px; color: #666; }
        .emergencia-call { width: 45px; height: 45px; border-radius: 50%; background: #00ff88; border: none; font-size: 20px; cursor: pointer; }
        
        /* Avaria */
        .avaria-form { padding: 15px; }
        .avaria-foto { width: 100%; height: 200px; background: #ffffff; border: 2px dashed #333; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; }
        .avaria-foto img { max-width: 100%; max-height: 100%; object-fit: cover; border-radius: 10px; }
        .avaria-textarea { width: 100%; background: #ffffff; border: 1px solid #ddd; border-radius: 12px; padding: 15px; color: #333; font-size: 14px; min-height: 100px; resize: none; margin-bottom: 15px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #ffffff; border-radius: 15px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; color: #333; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        
        /* Login */
        .login-container { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .login-logo { text-align: center; margin-bottom: 40px; }
        .login-logo h1 { font-size: 32px; color: #00d4ff; }
        .login-logo p { color: #666; margin-top: 10px; }
        .login-form { background: #ffffff; padding: 30px; border-radius: 20px; }
        .login-input { width: 100%; background: #f5f5f5; border: 1px solid #ddd; border-radius: 12px; padding: 15px; color: #333; font-size: 16px; margin-bottom: 15px; }
        .login-input:focus { border-color: #00d4ff; outline: none; }
        .login-btn { width: 100%; background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; padding: 15px; border-radius: 12px; color: #333; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        /* Notifica√ß√£o Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #00d4ff; color: #000; padding: 15px 25px; border-radius: 10px; z-index: 3000; display: none; font-weight: bold; }
        .toast.success { background: #00ff88; }
        .toast.error { background: #ff4444; color: #333; }
        .toast.active { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, 0); } }
        
        /* Som */
        .sound-enabled { }
    
/* ===== TEMA CLARO ===== */
body { background: #f0f2f5 !important; color: #333 !important; }
.login-container { background: #f0f2f5 !important; }
.login-form { background: #fff !important; border: 1px solid #ddd !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important; }
.login-input { background: #f5f5f5 !important; border: 1px solid #ddd !important; color: #333 !important; }
.login-logo h1 { color: #1a73e8 !important; }
.login-logo p { color: #666 !important; }
.header { background: #fff !important; color: #333 !important; border-bottom: 1px solid #e0e0e0 !important; box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important; }
.header h1 { color: #1a73e8 !important; }
.status-bar { background: #fff !important; border: 1px solid #e0e0e0 !important; }
.status-bar span { color: #333 !important; }
.corrida-card { background: #fff !important; border: 1px solid #e0e0e0 !important; box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important; color: #333 !important; }
.corrida-ativa { background: #fff !important; border: 1px solid #e0e0e0 !important; }
.corrida-ativa label { color: #888 !important; }
.corrida-ativa p { color: #333 !important; }
.bottom-nav { background: #fff !important; border-top: 1px solid #e0e0e0 !important; }
.bottom-nav a { color: #888 !important; }
.bottom-nav a.active { color: #1a73e8 !important; }
.panel, .card { background: #fff !important; border: 1px solid #e0e0e0 !important; color: #333 !important; }
.overlay-content { background: #fff !important; color: #333 !important; }
.nova-corrida-overlay .overlay-content { background: #fff !important; }
#novaCorridaOverlay { background: rgba(0,0,0,0.7) !important; }
.rota-info label { color: #888 !important; }
.rota-info p { color: #333 !important; font-weight: 500 !important; }
.btn-navegar { color: #fff !important; }
.btn-action { color: #fff !important; }
.btn-aceitar { color: #fff !important; }
.btn-cancelar { color: #ff4444 !important; border-color: #ff4444 !important; background: #fff !important; }
.toast { color: #fff !important; }
</style>
<script src="/js/gps-persistente.js"></script>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-logo">
            <h1>üöó UBMAX</h1>
            <p>Motorista</p>
        </div>
        <div class="login-form">
            <input type="tel" id="loginWhatsapp" class="login-input" placeholder="WhatsApp (ex: 11999999999)">
            <input type="password" id="loginSenha" class="login-input" placeholder="Senha PIN (6 digitos)">
            <button class="login-btn" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <!-- App Section -->
    <div id="appSection" style="display:none;">
        <!-- Header -->
        <div class="header">
            <h1>üöó UBMAX</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="toggleSound()">üîî</button>
                <button class="header-btn" onclick="abrirPerfil()">üë§</button>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div id="statusDot" class="status-dot offline"></div>
                <div>
                    <div id="statusText" class="status-text">Offline</div>
                    <div id="gpsInfo" class="gps-bar">üìç Aguardando GPS...</div>
                </div>
            </div>
            <button id="statusToggle" class="status-toggle offline" onclick="toggleStatus()">FICAR ONLINE</button>
        </div>

        <!-- Pages Container -->
        <div id="pagesContainer">
            <!-- HOME PAGE -->
            <div id="pageHome" class="page active">
                <!-- Dashboard Cards -->
                <div class="dashboard">
                    <div class="dash-card green">
                        <div class="icon">üí∞</div>
                        <div id="ganhosHoje" class="value">R$ 0</div>
                        <div class="label">Ganhos Hoje</div>
                    </div>
                    <div class="dash-card">
                        <div class="icon">üöó</div>
                        <div id="corridasHoje" class="value">0</div>
                        <div class="label">Corridas Hoje</div>
                    </div>
                    <div class="dash-card orange">
                        <div class="icon">‚è±Ô∏è</div>
                        <div id="horasOnline" class="value">0h</div>
                        <div class="label">Online Hoje</div>
                    </div>
                    <div class="dash-card">
                        <div class="icon">‚≠ê</div>
                        <div id="avaliacao" class="value">5.0</div>
                        <div class="label">Avalia√ß√£o</div>
                    </div>
                </div>

                <!-- Corrida Ativa -->
                <div id="corridaAtiva" class="corrida-ativa">
                    <div class="corrida-ativa-card">
                        <div class="corrida-ativa-header">
                            <span>üöó CORRIDA EM ANDAMENTO</span>
                            <span id="corridaValorAtiva">R$ 0,00</span>
                        </div>
                        <div class="corrida-ativa-body">
                            <div class="corrida-cliente">
                                <div class="cliente-avatar">üë§</div>
                                <div class="cliente-info">
                                    <h3 id="clienteNomeAtiva">Cliente</h3>
                                    <span id="clienteCorridasAtiva">0 corridas</span>
                                </div>
                            </div>
                            <div class="rota-item">
                                <div class="rota-icon origem">A</div>
                                <div class="rota-content">
                                    <label>BUSCAR EM</label>
                                    <p id="origemAtiva" style="font-size:16px;font-weight:bold;color:#1a73e8;margin:5px 0;">-</p>
                                    <div id="refOrigemAtivaBox" style="margin-top:8px;padding:10px;background:#fff3e0;border-left:4px solid #ff9800;border-radius:4px;display:none;">
                                        <span style="color:#e65100;font-weight:bold;">üìå REFER√äNCIA:</span>
                                        <p id="refOrigemAtivaText" style="margin:4px 0 0 0;color:#333;font-size:14px;"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="rota-item">
                                <div class="rota-icon destino">B</div>
                                <div class="rota-content">
                                    <label>LEVAR AT√â</label>
                                    <p id="destinoAtiva" style="font-size:15px;color:#333;margin:5px 0;">-</p>
                                    <div id="refDestinoAtivaBox" style="margin-top:8px;padding:10px;background:#e8f5e9;border-left:4px solid #4caf50;border-radius:4px;display:none;">
                                        <span style="color:#2e7d32;font-weight:bold;">üìå REFER√äNCIA:</span>
                                        <p id="refDestinoAtivaText" style="margin:4px 0 0 0;color:#333;font-size:14px;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="corrida-ativa-actions">
                            <button id="btnNavegar" class="btn-action btn-navegar" onclick="navegarAteCliente()">üó∫Ô∏è NAVEGAR</button>
                            <button id="btnLigarCliente" class="btn-action btn-ligar" onclick="ligarCliente()">üìû LIGAR CENTRAL</button>
                            <button id="btnCheguei" class="btn-action btn-cheguei" onclick="chegueiLocal()">üìç CHEGUEI NO LOCAL</button>
                            <button id="btnIniciar" class="btn-action btn-iniciar" onclick="iniciarCorrida()" style="display:none;">‚ñ∂Ô∏è INICIAR CORRIDA</button>
                            <button id="btnFinalizar" class="btn-action btn-finalizar" onclick="finalizarCorrida()" style="display:none;">‚úÖ FINALIZAR CORRIDA</button>
                            <button class="btn-action btn-cancelar" onclick="cancelarCorrida()">‚úñÔ∏è CANCELAR</button>
                        </div>
                    </div>
                </div>

                <!-- Sem corrida ativa -->
                <div id="semCorrida" style="text-align:center; padding:40px 20px; color:#888;">
                    <div style="font-size:60px; margin-bottom:20px;">üöó</div>
                    <h3 style="color:#fff; margin-bottom:10px;">Aguardando corridas</h3>
                    <p>Fique online para receber solicita√ß√µes</p>
                </div>
            </div>

            <!-- CHAT PAGE -->
            <div id="pageChat" class="page">
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <!-- Mensagens aparecem aqui -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Digite sua mensagem...">
                        <button class="chat-send" onclick="enviarMensagem()">‚û§</button>
                    </div>
                </div>
            </div>

            <!-- FINANCEIRO PAGE -->
            <div id="pageFinanceiro" class="page">
                <div class="financeiro-header">
                    <div class="financeiro-label">Saldo do Dia</div>
                    <div id="saldoDia" class="financeiro-saldo">R$ 0,00</div>
                </div>
                <div class="financeiro-actions">
                    <button class="fin-btn entrada" onclick="registrarEntrada()">+ Entrada</button>
                    <button class="fin-btn saida" onclick="registrarSaida()">- Sa√≠da</button>
                </div>
                <div class="transacoes-list" id="transacoesList">
                    <!-- Transa√ß√µes aparecem aqui -->
                </div>
            </div>

            <!-- RELAT√ìRIOS PAGE -->
            <div id="pageRelatorios" class="page">
                <div class="relatorio-card">
                    <div class="relatorio-periodo">
                        <button class="periodo-btn active" onclick="setPeriodo('hoje')">Hoje</button>
                        <button class="periodo-btn" onclick="setPeriodo('semana')">Semana</button>
                        <button class="periodo-btn" onclick="setPeriodo('mes')">M√™s</button>
                    </div>
                    <div class="relatorio-stats">
                        <div class="rel-stat">
                            <div id="relCorridas" class="value">0</div>
                            <div class="label">Corridas</div>
                        </div>
                        <div class="rel-stat">
                            <div id="relFaturamento" class="value">R$ 0</div>
                            <div class="label">Faturamento</div>
                        </div>
                        <div class="rel-stat">
                            <div id="relMedia" class="value">R$ 0</div>
                            <div class="label">M√©dia/Corrida</div>
                        </div>
                        <div class="rel-stat">
                            <div id="relHoras" class="value">0h</div>
                            <div class="label">Horas Online</div>
                        </div>
                    </div>
                </div>
                <div style="padding:15px;">
                    <h3 style="margin-bottom:15px;">üìä Melhores Semanas</h3>
                    <div id="melhoresSemanas"></div>
                </div>
            </div>

            <!-- MENU/MAIS PAGE -->
            <div id="pageMenu" class="page">
                <div style="padding:15px;">
                    <h3 style="margin-bottom:15px;">‚öôÔ∏è Menu</h3>
                    
                    <div class="emergencia-item" onclick="abrirEmergencia()">
                        <div class="emergencia-icon admin">üÜò</div>
                        <div class="emergencia-info">
                            <h3>Contatos de Emerg√™ncia</h3>
                            <span>Admin, Mec√¢nico, Guincho...</span>
                        </div>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="emergencia-item" onclick="abrirAvaria()">
                        <div class="emergencia-icon" style="background:#ff4444;">üì∏</div>
                        <div class="emergencia-info">
                            <h3>Reportar Avaria</h3>
                            <span>Tire foto e envie para o admin</span>
                        </div>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="emergencia-item" onclick="abrirReferencias()">
                        <div class="emergencia-icon" style="background:#9c27b0;">üìç</div>
                        <div class="emergencia-info">
                            <h3>Adicionar Refer√™ncia</h3>
                            <span>Cadastre pontos de refer√™ncia</span>
                        </div>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="emergencia-item" onclick="verValoresHorario()">
                        <div class="emergencia-icon" style="background:#00d4ff;">üí∞</div>
                        <div class="emergencia-info">
                            <h3>Tabela de Pre√ßos</h3>
                            <span>Valores por hor√°rio</span>
                        </div>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="emergencia-item" onclick="fazerLogout()" style="border:1px solid #ff4444;">
                        <div class="emergencia-icon" style="background:#ff4444;">üö™</div>
                        <div class="emergencia-info">
                            <h3>Sair</h3>
                            <span>Desconectar da conta</span>
                        </div>
                        <span>‚Ä∫</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showPage('pageHome')">
                <span class="icon">üè†</span>
                <span class="label">In√≠cio</span>
            </div>
            <div class="nav-item" onclick="showPage('pageChat')">
                <span class="icon">üí¨</span>
                <span class="label">Chat</span>
            </div>
            <div class="nav-item" onclick="showPage('pageFinanceiro')">
                <span class="icon">üí∞</span>
                <span class="label">Caixa</span>
            </div>
            <div class="nav-item" onclick="showPage('pageRelatorios')">
                <span class="icon">üìä</span>
                <span class="label">Relat√≥rio</span>
            </div>
            <div class="nav-item" onclick="showPage('pageMenu')">
                <span class="icon">‚ò∞</span>
                <span class="label">Menu</span>
            </div>
        </div>

        <!-- FAB Menu -->
        <div class="fab-container">
            <div id="fabMenu" class="fab-menu">
                <div class="fab-item" onclick="abrirEmergencia()">üÜò <span>Emerg√™ncia</span></div>
                <div class="fab-item" onclick="abrirAvaria()">üì∏ <span>Reportar Avaria</span></div>
                <div class="fab-item" onclick="abrirReferencias()">üìç <span>Add Refer√™ncia</span></div>
            </div>
            <button class="fab-btn" onclick="toggleFab()">+</button>
        </div>
    </div>

    <!-- Nova Corrida Overlay -->
    <div id="novaCorridaOverlay" class="nova-corrida-overlay">
        <div class="nova-corrida-card">
            <div class="corrida-header">
                <h2>üîî NOVA CORRIDA!</h2>
                <div id="novaCorridaValor" class="corrida-valor">R$ 25,00</div>
                <div id="novaCorridaDistancia" class="corrida-distancia">üìç 2.5 km de voc√™</div>
            </div>
            <div class="timer-bar">
                <div id="timerProgress" class="timer-progress" style="width:100%;"></div>
            </div>
            <div class="corrida-body">
                <div class="corrida-cliente">
                    <div class="cliente-avatar">üë§</div>
                    <div class="cliente-info">
                        <h3 id="novaCorridaCliente">Cliente</h3>
                        <span id="novaCorridaClienteInfo">‚≠ê 5.0 ‚Ä¢ 10 corridas</span>
                    </div>
                </div>
                <div class="corrida-info">
                    <label>üìç BUSCAR EM</label>
                    <span id="novaCorridaOrigem" style="font-size:16px;font-weight:bold;color:#1a73e8;">-</span>
                    <div id="novaCorridaRefOrigem" style="margin-top:8px;padding:10px;background:#fff3e0;border-left:4px solid #ff9800;border-radius:4px;display:none;">
                        <span style="color:#e65100;font-weight:bold;font-size:14px;">üìå REFER√äNCIA:</span>
                        <span id="novaCorridaRefOrigemText" style="display:block;margin-top:4px;color:#333;font-size:14px;"></span>
                    </div>
                </div>
                <div class="corrida-info">
                    <label>üèÅ LEVAR AT√â</label>
                    <span id="novaCorridaDestino" style="font-size:15px;color:#333;">-</span>
                    <div id="novaCorridaRefDestino" style="margin-top:8px;padding:10px;background:#e8f5e9;border-left:4px solid #4caf50;border-radius:4px;display:none;">
                        <span style="color:#2e7d32;font-weight:bold;font-size:14px;">üìå REFER√äNCIA:</span>
                        <span id="novaCorridaRefDestinoText" style="display:block;margin-top:4px;color:#333;font-size:14px;"></span>
                    </div>
                </div>
                <div class="corrida-actions">
                    <button class="btn-recusar" onclick="recusarCorrida()">‚úñÔ∏è RECUSAR</button>
                    <button class="btn-aceitar" onclick="aceitarCorrida()">‚úÖ ACEITAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Emerg√™ncia -->
    <div id="modalEmergencia" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üÜò Contatos de Emerg√™ncia</h3>
                <button class="modal-close" onclick="fecharModal('modalEmergencia')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="listaEmergencia" class="emergencia-list">
                    <!-- Carregado via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Avaria -->
    <div id="modalAvaria" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì∏ Reportar Avaria</h3>
                <button class="modal-close" onclick="fecharModal('modalAvaria')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="avaria-form">
                    <div class="avaria-foto" onclick="tirarFoto()">
                        <span id="fotoPreview">üì∑ Toque para tirar foto</span>
                        <input type="file" id="inputFoto" accept="image/*" capture="environment" style="display:none;" onchange="previewFoto(this)">
                    </div>
                    <textarea id="avariaDescricao" class="avaria-textarea" placeholder="Descreva o problema..."></textarea>
                    <button class="btn-action btn-finalizar" onclick="enviarAvaria()" style="width:100%;">üì§ ENVIAR PARA ADMIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Refer√™ncia -->
    <div id="modalReferencia" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìç Adicionar Refer√™ncia</h3>
                <button class="modal-close" onclick="fecharModal('modalReferencia')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="login-input" id="refNome" placeholder="Nome do local (ex: Padaria do Jo√£o)">
                <input type="text" class="login-input" id="refEndereco" placeholder="Endere√ßo ou descri√ß√£o">
                <select class="login-input" id="refCategoria">
                    <option value="">Selecione a categoria</option>
                    <option value="comercio">Com√©rcio</option>
                    <option value="residencia">Resid√™ncia</option>
                    <option value="ponto_taxi">Ponto de T√°xi</option>
                    <option value="hospital">Hospital/UBS</option>
                    <option value="escola">Escola</option>
                    <option value="outro">Outro</option>
                </select>
                <button class="btn-action btn-finalizar" onclick="salvarReferencia()" style="width:100%;">üíæ SALVAR</button>
            </div>
        </div>
    </div>

    <!-- Modal Entrada/Sa√≠da -->
    <div id="modalCaixa" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalCaixaTitulo">üí∞ Registrar</h3>
                <button class="modal-close" onclick="fecharModal('modalCaixa')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="number" class="login-input" id="caixaValor" placeholder="Valor (R$)" step="0.01">
                <input type="text" class="login-input" id="caixaDescricao" placeholder="Descri√ß√£o">
                <button id="btnSalvarCaixa" class="btn-action btn-finalizar" onclick="salvarCaixa()" style="width:100%;">üíæ SALVAR</button>
            </div>
        </div>
    </div>

    <!-- Modal Pre√ßos -->
    <div id="modalPrecos" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Tabela de Pre√ßos</h3>
                <button class="modal-close" onclick="fecharModal('modalPrecos')">&times;</button>
            </div>
            <div class="modal-body" id="tabelaPrecos">
                <!-- Carregado via JS -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Audio -->
    <audio id="somNovaCorrida" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNBrQ+AAAAAAAAAAAAAAAAAAAAAP/7UGQAD/AAADSAAAAANIAAAGkAAAABKQMc/gAAA0gAAAGoAAAAwMDAAAExMMA4DgOA5/5c/8uD/ygOA4f/l/5cH/+sAwMD/y4P/+XP/Lg//5cHAcBwfB8HwfB8AAAAD/+1JkMo/wAABpAAAAA0gAAAGkAAAAQZTBPNOQAArYGCeachABAAH/Lh/5f+XDg/+X/lw4P/+sHwfB8H/+XBwfB8HwfB//5cOA4Dg4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7UmRoD/AAAGkAAAADSAAANIAAAARhsME09BACtgYJp5CEAEAAAMDA/8v/Lh/5f/8uD4PgoD/y/8uH/l/5cHAcBwHAcBwHAcBwHAcBwHB8HwfB8HwfB8HwfB8HwfB8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7UGR+j/AAAGkAAAADSAAANIAAAAQgAAANIAAADSAAAANIAAABExERADARAwMRMQAAAQA0REBNEwMA0BAQAAAAAAAA0BANAQENaqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo=" type="audio/mpeg">
    </audio>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let motorista = null;
        let token = localStorage.getItem('motoristaToken');
        let corridaAtual = null;
        let gpsInterval = null;
        let checkInterval = null;
        let timerInterval = null;
        let tempoRestante = 30;
        let somAtivo = true;
        let minhaLatitude = null;
        let minhaLongitude = null;

        // ========== INICIALIZA√á√ÉO ==========
        if (token) {
            carregarMotorista();
        }

        // ========== LOGIN ==========
        async function fazerLogin() {
            const whatsapp = document.getElementById('loginWhatsapp').value;
            const senha = document.getElementById('loginSenha').value;
            if (!whatsapp) return toast('Digite o WhatsApp', 'error');
            if (!senha) return toast('Digite a senha PIN', 'error');

            try {
                const res = await fetch('/api/motorista-app/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ whatsapp, senha })
                });
                const data = await res.json();
                if (data.sucesso) {
                    motorista = data.motorista;
                    token = data.token;
                    localStorage.setItem('motoristaToken', token);
                    iniciarApp();
                    toast('Bem-vindo, ' + motorista.nomeCompleto + '!', 'success');
                } else {
                    toast(data.erro || 'Erro no login', 'error');
                }
            } catch (e) {
                toast('Erro de conex√£o', 'error');
            }
        }

        async function carregarMotorista() {
            try {
                const res = await fetch('/api/motorista-app/perfil', {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                if (data.motorista) {
                    motorista = data.motorista;
                    iniciarApp();
                } else {
                    fazerLogout();
                }
            } catch (e) {
                fazerLogout();
            }
        }

        function iniciarApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            atualizarStatusUI();
            iniciarGPS();
            iniciarChecks();
            carregarDashboard();
            carregarChat();
            verificarCorridaAtiva();
        }

        function fazerLogout() {
            localStorage.removeItem('motoristaToken');
            motorista = null;
            token = null;
            pararIntervalos();
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('appSection').style.display = 'none';
        }

        // ========== GPS ==========
        function iniciarGPS() {
            if (!navigator.geolocation) {
                document.getElementById('gpsInfo').textContent = '‚ùå GPS n√£o suportado';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => atualizarGPS(pos),
                (err) => {
                    document.getElementById('gpsInfo').textContent = '‚ùå Permita o GPS';
                    toast('Permita acesso √† localiza√ß√£o', 'error');
                },
                { enableHighAccuracy: true }
            );

            gpsInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    (pos) => atualizarGPS(pos),
                    () => {},
                    { enableHighAccuracy: true }
                );
            }, 10000);
        }

        async function atualizarGPS(pos) {
            minhaLatitude = pos.coords.latitude;
            minhaLongitude = pos.coords.longitude;
            document.getElementById('gpsInfo').textContent = 'üìç GPS ativo';
            document.getElementById('gpsInfo').classList.add('ativo');

            if (token && motorista?.status !== 'offline') {
                try {
                    await fetch('/api/motorista-app/gps', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': token },
                        body: JSON.stringify({ latitude: minhaLatitude, longitude: minhaLongitude })
                    });
                } catch (e) {}
            }
        }

        // ========== STATUS ==========
        async function toggleStatus() {
            const novoStatus = motorista.status === 'disponivel' ? 'offline' : 'disponivel';
            try {
                const res = await fetch('/api/motorista-app/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ status: novoStatus })
                });
                const data = await res.json();
                if (data.sucesso) {
                    motorista.status = novoStatus;
                    atualizarStatusUI();
                    toast(novoStatus === 'disponivel' ? 'Voc√™ est√° ONLINE!' : 'Voc√™ est√° OFFLINE', 'success');
                }
            } catch (e) {}
        }

        function atualizarStatusUI() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('statusToggle');

            dot.className = 'status-dot ' + motorista.status;

            if (motorista.status === 'disponivel') {
                text.textContent = 'Online - Aguardando corridas';
                btn.textContent = 'FICAR OFFLINE';
                btn.className = 'status-toggle online';
            } else if (motorista.status === 'em_corrida') {
                text.textContent = 'Em corrida';
                btn.textContent = 'EM CORRIDA';
                btn.disabled = true;
                btn.className = 'status-toggle';
            } else {
                text.textContent = 'Offline';
                btn.textContent = 'FICAR ONLINE';
                btn.disabled = false;
                btn.className = 'status-toggle offline';
            }

            document.getElementById('avaliacao').textContent = (motorista.avaliacao || 5).toFixed(1);
        }

        // ========== VERIFICAR CORRIDAS ==========
        function iniciarChecks() {
            checkInterval = setInterval(() => {
                if (motorista?.status === 'disponivel') {
                    verificarNovasCorridas();
                }
                carregarChat();
            }, 5000);
        }

        async function verificarNovasCorridas() {
            try {
                const res = await fetch('/api/motorista-app/corridas-disponiveis', {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                if (data.corridas && data.corridas.length > 0 && !corridaAtual) {
                    mostrarNovaCorrida(data.corridas[0]);
                }
            } catch (e) {}
        }

        async function verificarCorridaAtiva() {
            try {
                const res = await fetch('/api/motorista-app/corrida-ativa', {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                if (data.corrida) {
                    corridaAtual = data.corrida;
                    mostrarCorridaAtiva();
                }
            } catch (e) {}
        }

        
        // Formatar endereco - se for coordenadas, mostrar mais amigavel
        function formatarEndereco(local) {
            if (!local) return '-';
            if (local.endereco && !/^-?\d+\.\d+,\s*-?\d+\.\d+$/.test(local.endereco.trim())) {
                return local.endereco;
            }
            if (local.latitude && local.longitude) {
                return 'Loc: ' + parseFloat(local.latitude).toFixed(4) + ', ' + parseFloat(local.longitude).toFixed(4);
            }
            return local.endereco || '-';
        }

        // Navegacao direta Google Maps (sem confirm)
        function navegarPara(lat, lng, endereco) {
            if (!lat || !lng) {
                if (endereco) {
                    window.open('https://www.google.com/maps/search/' + encodeURIComponent(endereco), '_blank');
                    return;
                }
                toast('Sem coordenadas', 'error');
                return;
            }
            window.open('https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng + '&travelmode=driving', '_blank');
        }

        // ========== NOVA CORRIDA ==========
        function mostrarNovaCorrida(corrida) {
            corridaAtual = corrida;
            
            // Calcular dist√¢ncia
            let distancia = '-';
            if (minhaLatitude && corrida.origem?.latitude) {
                distancia = calcularDistancia(minhaLatitude, minhaLongitude, corrida.origem.latitude, corrida.origem.longitude).toFixed(1) + ' km de voc√™';
            }

            document.getElementById('novaCorridaValor').textContent = 'R$ ' + (corrida.precoEstimado || 0).toFixed(2);
            document.getElementById('novaCorridaDistancia').textContent = 'üìç ' + distancia;
            document.getElementById('novaCorridaCliente').textContent = corrida.clienteNome || 'Cliente';
            document.getElementById('novaCorridaOrigem').textContent = formatarEndereco(corrida.origem);
            document.getElementById('novaCorridaDestino').textContent = formatarEndereco(corrida.destino);

            // Mostrar refer√™ncia da origem em destaque
            const refOrigemBox = document.getElementById('novaCorridaRefOrigem');
            const refOrigemText = document.getElementById('novaCorridaRefOrigemText');
            if (refOrigemBox && refOrigemText) {
                const refOrigem = corrida.observacaoOrigem || corrida.origem?.referencia || corrida.origem?.observacao;
                if (refOrigem) {
                    refOrigemText.textContent = refOrigem;
                    refOrigemBox.style.display = 'block';
                } else {
                    refOrigemBox.style.display = 'none';
                }
            }
            
            // Mostrar refer√™ncia do destino em destaque
            const refDestinoBox = document.getElementById('novaCorridaRefDestino');
            const refDestinoText = document.getElementById('novaCorridaRefDestinoText');
            if (refDestinoBox && refDestinoText) {
                const refDestino = corrida.observacaoDestino || corrida.destino?.referencia || corrida.destino?.observacao;
                if (refDestino) {
                    refDestinoText.textContent = refDestino;
                    refDestinoBox.style.display = 'block';
                } else {
                    refDestinoBox.style.display = 'none';
                }
            }

            document.getElementById('novaCorridaOverlay').classList.add('active');
            
            // Timer
            tempoRestante = 30;
            document.getElementById('timerProgress').style.width = '100%';
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                tempoRestante--;
                document.getElementById('timerProgress').style.width = (tempoRestante / 30 * 100) + '%';
                if (tempoRestante <= 0) {
                    recusarCorrida();
                }
            }, 1000);

            // Som
            if (somAtivo) {
                try { document.getElementById('somNovaCorrida').play(); } catch(e) {}
            }
        }

        async function aceitarCorrida() {
            if (!corridaAtual) return;
            clearInterval(timerInterval);

            try {
                const res = await fetch('/api/motorista-app/aceitar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ corridaId: corridaAtual._id })
                });
                const data = await res.json();
                if (data.sucesso) {
                    corridaAtual = data.corrida;
                    motorista.status = 'em_corrida';
                    atualizarStatusUI();
                    document.getElementById('novaCorridaOverlay').classList.remove('active');
                    mostrarCorridaAtiva();
                    toast('Corrida aceita!', 'success');
                } else {
                    toast(data.erro || 'Erro ao aceitar', 'error');
                    recusarCorrida();
                }
            } catch (e) {
                toast('Erro de conex√£o', 'error');
            }
        }

        function recusarCorrida() {
            clearInterval(timerInterval);
            document.getElementById('novaCorridaOverlay').classList.remove('active');
            corridaAtual = null;
        }

        // ========== CORRIDA ATIVA ==========
        function mostrarCorridaAtiva() {
            document.getElementById('semCorrida').style.display = 'none';
            document.getElementById('corridaAtiva').classList.add('active');

            document.getElementById('corridaValorAtiva').textContent = 'R$ ' + (corridaAtual.precoEstimado || 0).toFixed(2);
            document.getElementById('clienteNomeAtiva').textContent = corridaAtual.clienteNome || 'Cliente';
            document.getElementById('origemAtiva').textContent = formatarEndereco(corridaAtual.origem);
            document.getElementById('destinoAtiva').textContent = formatarEndereco(corridaAtual.destino);

            // Referencia origem - box destacado
            const refOrigemBox = document.getElementById('refOrigemAtivaBox');
            const refOrigemText = document.getElementById('refOrigemAtivaText');
            const refOrigem = corridaAtual.observacaoOrigem || corridaAtual.origem?.referencia || corridaAtual.origem?.observacao;
            if (refOrigemBox && refOrigemText && refOrigem) {
                refOrigemText.textContent = refOrigem;
                refOrigemBox.style.display = 'block';
            } else if (refOrigemBox) { refOrigemBox.style.display = 'none'; }

            // Referencia destino - box destacado
            const refDestinoBox = document.getElementById('refDestinoAtivaBox');
            const refDestinoText = document.getElementById('refDestinoAtivaText');
            const refDestino = corridaAtual.observacaoDestino || corridaAtual.destino?.referencia || corridaAtual.destino?.observacao;
            if (refDestinoBox && refDestinoText && refDestino) {
                refDestinoText.textContent = refDestino;
                refDestinoBox.style.display = 'block';
            } else if (refDestinoBox) { refDestinoBox.style.display = 'none'; }

            atualizarBotoesCorridaAtiva();
        }

        function atualizarBotoesCorridaAtiva() {
            const status = corridaAtual?.status;
            document.getElementById('btnCheguei').style.display = status === 'aceita' ? 'flex' : 'none';
            document.getElementById('btnIniciar').style.display = status === 'a_caminho' ? 'flex' : 'none';
            document.getElementById('btnFinalizar').style.display = status === 'em_andamento' ? 'flex' : 'none';
        }

        function navegarAteCliente() {
            const origem = corridaAtual?.origem;
            if (!origem?.latitude && !origem?.endereco) {
                toast('Sem endereco para navegar', 'error');
                return;
            }
            navegarPara(origem.latitude, origem.longitude, origem.endereco);
        }

        function ligarCliente() {
            // Liga para central, n√£o para cliente diretamente
            toast('Conectando com a central...', 'success');
            // Aqui integraria com Rebeca para fazer liga√ß√£o mascarada
        }

        async function chegueiLocal() {
            try {
                await fetch('/api/motorista-app/cheguei', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ corridaId: corridaAtual._id })
                });
                corridaAtual.status = 'a_caminho';
                atualizarBotoesCorridaAtiva();
                toast('Cliente notificado!', 'success');
            } catch (e) {}
        }

        async function iniciarCorrida() {
            try {
                const res = await fetch('/api/motorista-app/iniciar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ corridaId: corridaAtual._id })
                });
                const data = await res.json();
                if (data.sucesso) {
                    corridaAtual.status = 'em_andamento';
                    atualizarBotoesCorridaAtiva();
                    toast('Corrida iniciada!', 'success');
                }
            } catch (e) {}
        }

        async function finalizarCorrida() {
            try {
                const res = await fetch('/api/motorista-app/finalizar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ corridaId: corridaAtual._id })
                });
                const data = await res.json();
                if (data.sucesso) {
                    toast('Corrida finalizada! R$ ' + (data.corrida?.precoFinal || 0).toFixed(2), 'success');
                    corridaAtual = null;
                    motorista.status = 'disponivel';
                    atualizarStatusUI();
                    document.getElementById('corridaAtiva').classList.remove('active');
                    document.getElementById('semCorrida').style.display = 'block';
                    carregarDashboard();
                }
            } catch (e) {}
        }

        async function cancelarCorrida() {
            if (!confirm('Cancelar esta corrida?')) return;
            try {
                await fetch('/api/motorista-app/cancelar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ corridaId: corridaAtual._id, motivo: 'Cancelado pelo motorista' })
                });
                corridaAtual = null;
                motorista.status = 'disponivel';
                atualizarStatusUI();
                document.getElementById('corridaAtiva').classList.remove('active');
                document.getElementById('semCorrida').style.display = 'block';
                toast('Corrida cancelada', 'error');
            } catch (e) {}
        }

        // ========== DASHBOARD ==========
        async function carregarDashboard() {
            try {
                const res = await fetch('/api/motorista-app/estatisticas', {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                document.getElementById('ganhosHoje').textContent = 'R$ ' + (data.ganhosHoje || 0).toFixed(2);
                document.getElementById('corridasHoje').textContent = data.corridasHoje || 0;
                document.getElementById('horasOnline').textContent = (data.horasOnline || 0) + 'h';
            } catch (e) {}
        }

        // ========== CHAT ==========
        async function carregarChat() {
            try {
                const res = await fetch('/api/motorista-app/chat', {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                renderizarChat(data.mensagens || []);
            } catch (e) {}
        }

        function renderizarChat(mensagens) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = mensagens.map(m => `
                <div class="chat-msg ${m.remetente === motorista._id ? 'sent' : 'received'}">
                    <div class="bubble">${m.texto}</div>
                    <div class="meta">${m.nomeRemetente || 'Admin'} ‚Ä¢ ${new Date(m.data).toLocaleTimeString()}</div>
                </div>
            `).join('') || '<p style="text-align:center;color:#888;padding:20px;">Nenhuma mensagem</p>';
            container.scrollTop = container.scrollHeight;
        }

        async function enviarMensagem() {
            const input = document.getElementById('chatInput');
            const texto = input.value.trim();
            if (!texto) return;

            try {
                await fetch('/api/motorista-app/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ texto })
                });
                input.value = '';
                carregarChat();
            } catch (e) {}
        }

        // ========== FINANCEIRO ==========
        let tipoCaixa = 'entrada';

        function registrarEntrada() {
            tipoCaixa = 'entrada';
            document.getElementById('modalCaixaTitulo').textContent = 'üí∞ Registrar Entrada';
            document.getElementById('btnSalvarCaixa').className = 'btn-action btn-finalizar';
            abrirModal('modalCaixa');
        }

        function registrarSaida() {
            tipoCaixa = 'saida';
            document.getElementById('modalCaixaTitulo').textContent = 'üí∏ Registrar Sa√≠da';
            document.getElementById('btnSalvarCaixa').className = 'btn-action btn-cheguei';
            abrirModal('modalCaixa');
        }

        async function salvarCaixa() {
            const valor = parseFloat(document.getElementById('caixaValor').value);
            const descricao = document.getElementById('caixaDescricao').value;
            if (!valor) return toast('Digite o valor', 'error');

            try {
                await fetch('/api/motorista-app/caixa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ tipo: tipoCaixa, valor, descricao })
                });
                toast(tipoCaixa === 'entrada' ? 'Entrada registrada!' : 'Sa√≠da registrada!', 'success');
                fecharModal('modalCaixa');
                document.getElementById('caixaValor').value = '';
                document.getElementById('caixaDescricao').value = '';
                carregarFinanceiro();
            } catch (e) {}
        }

        async function carregarFinanceiro() {
            try {
                const res = await fetch('/api/motorista-app/caixa', {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                document.getElementById('saldoDia').textContent = 'R$ ' + (data.saldo || 0).toFixed(2);
                renderizarTransacoes(data.transacoes || []);
            } catch (e) {}
        }

        function renderizarTransacoes(transacoes) {
            document.getElementById('transacoesList').innerHTML = transacoes.map(t => `
                <div class="transacao-item">
                    <div>
                        <strong>${t.descricao || (t.tipo === 'entrada' ? 'Entrada' : 'Sa√≠da')}</strong>
                        <div style="font-size:12px;color:#888;">${new Date(t.data).toLocaleString()}</div>
                    </div>
                    <div class="valor ${t.tipo === 'entrada' ? 'positivo' : 'negativo'}">
                        ${t.tipo === 'entrada' ? '+' : '-'} R$ ${t.valor.toFixed(2)}
                    </div>
                </div>
            `).join('') || '<p style="text-align:center;color:#888;">Nenhuma transa√ß√£o hoje</p>';
        }

        // ========== EMERG√äNCIA ==========
        async function abrirEmergencia() {
            abrirModal('modalEmergencia');
            try {
                const res = await fetch('/api/config/emergencia');
                const data = await res.json();
                renderizarEmergencia(data.contatos || []);
            } catch (e) {
                renderizarEmergencia([
                    { nome: 'Admin/Suporte', telefone: '11999999999', tipo: 'admin' },
                    { nome: 'Mec√¢nico', telefone: '11988888888', tipo: 'mecanico' }
                ]);
            }
        }

        function renderizarEmergencia(contatos) {
            document.getElementById('listaEmergencia').innerHTML = contatos.map(c => `
                <div class="emergencia-item">
                    <div class="emergencia-icon ${c.tipo}">${getIconeEmergencia(c.tipo)}</div>
                    <div class="emergencia-info">
                        <h3>${c.nome}</h3>
                        <span>${c.categoria || c.tipo}</span>
                    </div>
                    <button class="emergencia-call" onclick="ligar('${c.telefone}')">üìû</button>
                </div>
            `).join('');
        }

        function getIconeEmergencia(tipo) {
            const icones = { admin: 'üëî', mecanico: 'üîß', guincho: 'üöõ', borracheiro: 'üõû', suporte: 'üí¨' };
            return icones[tipo] || 'üìû';
        }

        function ligar(telefone) {
            window.open('tel:' + telefone);
        }

        // ========== AVARIA ==========
        function abrirAvaria() {
            abrirModal('modalAvaria');
        }

        function tirarFoto() {
            document.getElementById('inputFoto').click();
        }

        function previewFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('fotoPreview').innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:180px;border-radius:10px;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function enviarAvaria() {
            const descricao = document.getElementById('avariaDescricao').value;
            const fotoInput = document.getElementById('inputFoto');
            
            if (!descricao) return toast('Descreva o problema', 'error');

            // Aqui enviaria para o backend com a foto
            toast('Avaria reportada! Admin notificado.', 'success');
            fecharModal('modalAvaria');
            document.getElementById('avariaDescricao').value = '';
            document.getElementById('fotoPreview').innerHTML = 'üì∑ Toque para tirar foto';
        }

        // ========== REFER√äNCIAS ==========
        function abrirReferencias() {
            abrirModal('modalReferencia');
        }

        async function salvarReferencia() {
            const nome = document.getElementById('refNome').value;
            const endereco = document.getElementById('refEndereco').value;
            const categoria = document.getElementById('refCategoria').value;

            if (!nome || !endereco) return toast('Preencha todos os campos', 'error');

            try {
                await fetch('/api/pontos-referencia', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ nome, endereco, categoria, latitude: minhaLatitude, longitude: minhaLongitude })
                });
                toast('Refer√™ncia salva!', 'success');
                fecharModal('modalReferencia');
            } catch (e) {}
        }

        // ========== PRE√áOS ==========
        async function verValoresHorario() {
            abrirModal('modalPrecos');
            try {
                const res = await fetch('/api/preco-dinamico/atual');
                const data = await res.json();
                document.getElementById('tabelaPrecos').innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <h2 style="color:#00d4ff;margin-bottom:10px;">Multiplicador Atual</h2>
                        <div style="font-size:48px;font-weight:bold;color:#00ff88;">${data.multiplicador || 1}x</div>
                        <p style="color:#888;margin-top:10px;">${data.faixa || 'Normal'}</p>
                        <hr style="border-color:#333;margin:20px 0;">
                        <p>Taxa Base: R$ ${data.taxaBase || 5}</p>
                        <p>Pre√ßo/Km: R$ ${data.precoKm || 2.5}</p>
                        <p>M√≠nimo: R$ ${data.taxaMinima || 15}</p>
                    </div>
                `;
            } catch (e) {}
        }

        // ========== RELAT√ìRIOS ==========
        async function setPeriodo(periodo) {
            document.querySelectorAll('.periodo-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            try {
                const res = await fetch('/api/motorista-app/relatorio?periodo=' + periodo, {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                document.getElementById('relCorridas').textContent = data.corridas || 0;
                document.getElementById('relFaturamento').textContent = 'R$ ' + (data.faturamento || 0).toFixed(2);
                document.getElementById('relMedia').textContent = 'R$ ' + (data.media || 0).toFixed(2);
                document.getElementById('relHoras').textContent = (data.horas || 0) + 'h';
            } catch (e) {}
        }

        // ========== NAVEGA√á√ÉO ==========
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.currentTarget.classList.add('active');

            if (pageId === 'pageFinanceiro') carregarFinanceiro();
            if (pageId === 'pageRelatorios') setPeriodo('hoje');
        }

        // ========== MODAIS ==========
        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ========== FAB ==========
        function toggleFab() {
            document.getElementById('fabMenu').classList.toggle('active');
        }

        // ========== UTILS ==========
        function toast(msg, tipo = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast active ' + tipo;
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        function toggleSound() {
            somAtivo = !somAtivo;
            toast(somAtivo ? 'üîî Som ativado' : 'üîï Som desativado');
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function pararIntervalos() {
            if (gpsInterval) clearInterval(gpsInterval);
            if (checkInterval) clearInterval(checkInterval);
            if (timerInterval) clearInterval(timerInterval);
        }

        function abrirPerfil() {
            toast('Perfil: ' + motorista.nomeCompleto);
        }

        // Enter no chat
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') enviarMensagem();
            });
        });
    </script>
    <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js");
    }
    </script>
</body>
</html>

<!-- Modal Chat com Cliente via Rebeca -->
<div id="modalChatCliente" class="modal-overlay">
    <div class="modal-content" style="height:80vh;display:flex;flex-direction:column;">
        <div class="modal-header" style="background:#00d4ff;color:#000;">
            <h3>üí¨ Chat com Cliente (via Rebeca)</h3>
            <button class="modal-close" onclick="fecharModal('modalChatCliente')" style="color:#000;">&times;</button>
        </div>
        <div style="padding:10px;background:#1a1a2e;border-bottom:1px solid #333;">
            <small style="color:#888;">‚ö†Ô∏è Comunica√ß√£o dispon√≠vel apenas antes de iniciar a corrida</small>
        </div>
        <div id="chatClienteMensagens" style="flex:1;overflow-y:auto;padding:15px;background:#1a1a2e;">
            <!-- Mensagens aparecem aqui -->
        </div>
        <div style="padding:10px;background:#252542;">
            <div style="margin-bottom:10px;">
                <small style="color:#888;">Mensagens R√°pidas:</small>
                <div id="mensagensRapidas" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;">
                    <!-- Carregadas via JS -->
                </div>
            </div>
            <div style="display:flex;gap:10px;">
                <input type="text" id="inputMsgCliente" class="chat-input" placeholder="Digite sua mensagem..." style="flex:1;">
                <button class="chat-send" onclick="enviarMsgCliente()">‚û§</button>
            </div>
        </div>
    </div>
</div>

<script>
// ========== CHAT COM CLIENTE VIA REBECA ==========
let chatClienteInterval = null;

async function abrirChatCliente() {
    if (!corridaAtual) {
        toast('Nenhuma corrida ativa', 'error');
        return;
    }
    
    if (corridaAtual.status === 'em_andamento' || corridaAtual.status === 'finalizada') {
        toast('Chat dispon√≠vel apenas antes de iniciar', 'error');
        return;
    }
    
    document.getElementById('modalChatCliente').classList.add('active');
    carregarMensagensRapidas();
    carregarMensagensCliente();
    
    // Atualizar a cada 5 segundos
    chatClienteInterval = setInterval(carregarMensagensCliente, 5000);
}

function fecharChatCliente() {
    document.getElementById('modalChatCliente').classList.remove('active');
    if (chatClienteInterval) clearInterval(chatClienteInterval);
}

async function carregarMensagensRapidas() {
    try {
        const res = await fetch('/api/comunicacao/mensagens-rapidas');
        const msgs = await res.json();
        
        document.getElementById('mensagensRapidas').innerHTML = msgs.map(m => 
            `<button onclick="usarMsgRapida('${m.texto}')" style="background:#333;border:none;color:#fff;padding:5px 10px;border-radius:15px;font-size:12px;cursor:pointer;">${m.texto}</button>`
        ).join('');
    } catch (e) {}
}

function usarMsgRapida(texto) {
    document.getElementById('inputMsgCliente').value = texto;
}

async function carregarMensagensCliente() {
    if (!corridaAtual) return;
    
    try {
        const res = await fetch(`/api/comunicacao/corrida/${corridaAtual._id}`);
        const msgs = await res.json();
        
        const container = document.getElementById('chatClienteMensagens');
        container.innerHTML = msgs.length > 0 ? msgs.map(m => `
            <div style="margin-bottom:15px;${m.remetente === 'motorista' ? 'text-align:right;' : ''}">
                <div style="display:inline-block;max-width:80%;padding:10px 15px;border-radius:15px;${
                    m.remetente === 'motorista' 
                        ? 'background:#00d4ff;color:#000;border-bottom-right-radius:5px;' 
                        : m.remetente === 'rebeca'
                            ? 'background:#9c27b0;color:#fff;border-bottom-left-radius:5px;'
                            : 'background:#252542;border-bottom-left-radius:5px;'
                }">
                    ${m.mensagem}
                </div>
                <div style="font-size:10px;color:#666;margin-top:3px;">
                    ${m.remetente === 'motorista' ? '‚úì Voc√™' : m.remetente === 'rebeca' ? 'ü§ñ Rebeca' : 'üë§ Cliente'} ‚Ä¢ ${new Date(m.createdAt).toLocaleTimeString()}
                </div>
            </div>
        `).join('') : '<p style="text-align:center;color:#888;">Nenhuma mensagem ainda.<br>Envie uma mensagem para o cliente!</p>';
        
        container.scrollTop = container.scrollHeight;
        
        // Marcar como lidas
        const naoLidas = msgs.filter(m => m.destinatario === 'motorista' && !m.lida);
        for (const msg of naoLidas) {
            await fetch(`/api/comunicacao/marcar-lida/${msg._id}`, { method: 'POST' });
        }
    } catch (e) {}
}

async function enviarMsgCliente() {
    const input = document.getElementById('inputMsgCliente');
    const mensagem = input.value.trim();
    
    if (!mensagem) return;
    if (!corridaAtual) return;
    
    try {
        const res = await fetch('/api/comunicacao/motorista-para-cliente', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                corridaId: corridaAtual._id,
                mensagem,
                motoristaToken: token
            })
        });
        
        const data = await res.json();
        
        if (data.sucesso) {
            input.value = '';
            carregarMensagensCliente();
            toast('Mensagem enviada via Rebeca!', 'success');
        } else {
            toast(data.erro || 'Erro ao enviar', 'error');
        }
    } catch (e) {
        toast('Erro de conex√£o', 'error');
    }
}

// Verificar mensagens n√£o lidas periodicamente
async function verificarMensagensNaoLidas() {
    if (!corridaAtual) return;
    
    try {
        const res = await fetch(`/api/comunicacao/nao-lidas/${corridaAtual._id}`);
        const msgs = await res.json();
        
        if (msgs.length > 0) {
            toast(`üí¨ ${msgs.length} nova(s) mensagem(ns) do cliente!`, 'success');
        }
    } catch (e) {}
}

// Substituir fun√ß√£o ligarCliente
function ligarCliente() {
    abrirChatCliente();
}

// Enter para enviar
document.getElementById('inputMsgCliente')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') enviarMsgCliente();
});
</script>

<script>
// ========== SUBSTITUIR GPS ANTIGO POR PERSISTENTE ==========
async function iniciarGPSPersistente() {
    try {
        await GPSPersistente.iniciar();
        
        // Atualizar UI
        document.getElementById('gpsInfo').textContent = 'üìç GPS ativo';
        document.getElementById('gpsInfo').classList.add('ativo');
        
        // Registrar callback para enviar ao servidor
        GPSPersistente.onAtualizar(async (lat, lng, precisao) => {
            minhaLatitude = lat;
            minhaLongitude = lng;
            
            // Atualizar display
            if (document.getElementById('coordsDisplay')) {
                document.getElementById('coordsDisplay').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)} (¬±${precisao.toFixed(0)}m)`;
            }
            
            // Enviar para servidor se estiver logado
            if (token && motorista?.status !== 'offline') {
                try {
                    await fetch('/api/motorista-app/gps', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': token 
                        },
                        body: JSON.stringify({ latitude: lat, longitude: lng, precisao })
                    });
                } catch (e) {}
            }
        });
        
        toast('üìç GPS ativado com sucesso!', 'success');
        
    } catch (e) {
        document.getElementById('gpsInfo').textContent = '‚ùå GPS n√£o permitido';
        toast('Permita o acesso ao GPS para usar o app', 'error');
    }
}

// Substituir fun√ß√£o antiga
const iniciarGPSOriginal = iniciarGPS;
iniciarGPS = function() {
    iniciarGPSPersistente();
};
</script>
