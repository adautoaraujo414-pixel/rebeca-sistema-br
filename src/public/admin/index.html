<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBMAX Rebeca - Painel Admin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; }
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; }
        .header h1 span { color: #e94560; }
        .btn-logout { background: #e94560; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .container { display: flex; min-height: calc(100vh - 70px); }
        .sidebar { width: 260px; background: #1a1a2e; padding: 20px 0; overflow-y: auto; }
        .menu-item { padding: 12px 20px; color: #ccc; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s; border-left: 3px solid transparent; font-size: 0.95em; }
        .menu-item:hover, .menu-item.active { background: rgba(233,69,96,0.2); color: white; border-left-color: #e94560; }
        .menu-section { padding: 15px 20px 5px; color: #666; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; }
        .main-content { flex: 1; padding: 25px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .card-icon { font-size: 2em; margin-bottom: 8px; }
        .card h3 { color: #666; font-size: 0.85em; margin-bottom: 5px; }
        .card .value { font-size: 1.8em; font-weight: bold; color: #1a1a2e; }
        .card.green { border-left: 4px solid #27ae60; }
        .card.blue { border-left: 4px solid #3498db; }
        .card.orange { border-left: 4px solid #f39c12; }
        .card.red { border-left: 4px solid #e74c3c; }
        .card.purple { border-left: 4px solid #9b59b6; }
        .panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel h2 { color: #1a1a2e; margin-bottom: 15px; font-size: 1.2em; }
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #f0f2f5; font-size: 0.9em; }
        th { background: #f8f9fa; font-weight: 600; color: #666; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 500; }
        .badge.green { background: #d4edda; color: #155724; }
        .badge.blue { background: #cce5ff; color: #004085; }
        .badge.yellow { background: #fff3cd; color: #856404; }
        .badge.red { background: #f8d7da; color: #721c24; }
        .badge.purple { background: #e2d9f3; color: #6f42c1; }
        .badge.orange { background: #ffe5d0; color: #d35400; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; transition: all 0.3s; margin: 2px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn:hover { opacity: 0.85; transform: translateY(-1px); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 25px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar input, .search-bar select { flex: 1; min-width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; }
        #mapaLeaflet, #mapaGoogle { height: 400px; border-radius: 10px; }
        .chart-container { height: 300px; position: relative; }
        .ranking-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f2f5; }
        .ranking-pos { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; color: white; }
        .ranking-pos.gold { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .ranking-pos.silver { background: linear-gradient(135deg, #bdc3c7, #95a5a6); }
        .ranking-pos.bronze { background: linear-gradient(135deg, #e67e22, #d35400); }
        .ranking-pos.normal { background: #666; }
        .ranking-info h4 { margin: 0; font-size: 1em; }
        .ranking-stats .valor { font-size: 1.2em; font-weight: bold; color: #27ae60; }
        .pico-container { display: flex; align-items: center; margin: 5px 0; }
        .pico-bar { height: 25px; border-radius: 5px; }
        .pico-bar.alto { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .pico-bar.medio { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .pico-bar.baixo { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .hora-label { display: inline-block; width: 50px; font-size: 0.85em; color: #666; }
        .pico-value { margin-left: 10px; font-size: 0.85em; font-weight: 500; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-indicator.online { background: #27ae60; }
        .status-indicator.offline { background: #e74c3c; }
        .token-box { background: linear-gradient(135deg, #27ae60, #2ecc71); border-radius: 12px; padding: 20px; margin-top: 20px; color: white; text-align: center; }
        .token-box code { background: rgba(0,0,0,0.3); padding: 12px 20px; border-radius: 8px; font-size: 1em; display: block; margin: 10px 0; word-break: break-all; }
        .divider { border: none; border-top: 2px solid #eee; margin: 20px 0; }
        .alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #cce5ff; color: #004085; }
        .log-item { padding: 10px; border-left: 3px solid #3498db; margin-bottom: 8px; background: #f8f9fa; border-radius: 0 8px 8px 0; }
        .alerta-fraude { padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid; }
        .alerta-fraude.critico { background: #ffeaea; border-left-color: #c0392b; }
        .alerta-fraude.alto { background: #fff5f5; border-left-color: #e74c3c; }
        .alerta-fraude.medio { background: #fff8e6; border-left-color: #f39c12; }
        .alerta-fraude.baixo { background: #e8f8f5; border-left-color: #27ae60; }
        .alerta-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .alerta-motivos { font-size: 0.9em; color: #666; }
        .alerta-motivos li { margin: 3px 0; }
        .rota-info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .rota-detalhe { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .modo-card { padding: 20px; border: 3px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; }
        .modo-card:hover { border-color: #3498db; }
        .modo-card.active { border-color: #27ae60; background: #f0fff4; }
        .modo-card h3 { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .modo-card p { color: #666; font-size: 0.9em; margin: 0; }
        .modo-icon { font-size: 2em; }
        .corrida-despacho { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #3498db; }
        .corrida-despacho.aguardando { border-left-color: #f39c12; }
        .faixa-item { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .faixa-item.alta { border-left: 4px solid #e74c3c; }
        .faixa-item.media { border-left: 4px solid #f39c12; }
        .faixa-item.normal { border-left: 4px solid #27ae60; }
        .faixa-item.fixo { border-left: 4px solid #9b59b6; }
        .faixa-info h4 { margin: 0 0 5px 0; }
        .faixa-info small { color: #666; }
        .faixa-valores { text-align: right; }
        .faixa-valores .mult { font-size: 1.3em; font-weight: bold; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #f0f2f5; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .tab.active { background: #3498db; color: white; }
        .tab:hover:not(.active) { background: #e0e0e0; }
        .tipo-preco { display: flex; gap: 10px; margin-bottom: 15px; }
        .tipo-preco-btn { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .tipo-preco-btn:hover { border-color: #3498db; }
        .tipo-preco-btn.active { border-color: #27ae60; background: #f0fff4; }
        .tipo-preco-btn h4 { margin: 0 0 5px 0; }
        .tipo-preco-btn p { margin: 0; font-size: 0.85em; color: #666; }
        .campos-tipo { display: none; }
        .campos-tipo.active { display: block; }
    </style>
</head>
<body>
<script>
    // Verificar login obrigatÃ³rio
    const token = localStorage.getItem('token');
    const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
    if (!token || !usuario._id) {
        alert('FaÃ§a login primeiro!');
        window.location.href = '/admin/login.html';
    }
</script>
    <header class="header">
        <h1>UB<span>MAX</span> Rebeca</h1>
        <div style="display:flex;align-items:center;gap:20px;">
            <div style="text-align:right;"><div id="userName">Admin</div><small id="userRole" style="opacity:0.8;">Administrador</small></div>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </header>

    <div class="container">
        <nav class="sidebar">
            <div class="menu-section">Principal</div>
            <div class="menu-item active" data-page="dashboard">ğŸ“Š Dashboard</div>
            <div class="menu-item" data-page="mapa">ğŸ—ºï¸ Mapa Tempo Real</div>
            
            <div class="menu-section">OperaÃ§Ãµes</div>
            <div class="menu-item" data-page="corridas">ğŸš— Corridas</div>
            <div class="menu-item" data-page="despacho">ğŸ“¡ Despacho</div>
            <div class="menu-item" data-page="motoristas">ğŸ‘¨â€âœˆï¸ Motoristas</div>
            <div class="menu-item" data-page="clientes">ğŸ‘¥ Clientes</div>
            <div class="menu-item" data-page="rotas">ğŸ“ Calcular Rota</div>
            
            <div class="menu-section">Financeiro</div>
            <div class="menu-item" data-page="faturamento">ğŸ’° Faturamento</div>
            <div class="menu-item" data-page="precos">ğŸ’µ PreÃ§os DinÃ¢micos</div>
            <div class="menu-item" data-page="ranking">ğŸ† Ranking</div>
            
            <div class="menu-section">SeguranÃ§a</div>
            <div class="menu-item" data-page="antifraude">ğŸ›¡ï¸ Anti-Fraude</div>
            <div class="menu-item" data-page="blacklist">ğŸš« Blacklist</div>
            
            <div class="menu-section">Atendimento</div>
            <div class="menu-item" data-page="reclamacoes">ğŸ“ ReclamaÃ§Ãµes</div>
            <div class="menu-item" data-page="whatsapp">ğŸ’¬ WhatsApp</div>
            
            <div class="menu-section">Sistema</div>
            <div class="menu-item" data-page="usuarios">ğŸ‘¤ UsuÃ¡rios Admin</div>
            <div class="menu-item" data-page="areas">ğŸ—ºï¸ Ãreas</div>
            <div class="menu-item" data-page="config">âš™ï¸ ConfiguraÃ§Ãµes</div>
            <div class="menu-item" data-page="logs">ğŸ“œ Logs</div>
        </nav>

        <main class="main-content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <h2 style="margin-bottom:20px;">ğŸ“Š Dashboard</h2>
                <div class="cards">
                    <div class="card green"><div class="card-icon">ğŸŸ¢</div><h3>Motoristas Online</h3><div class="value" id="motoristasOnline">0</div></div>
                    <div class="card blue"><div class="card-icon">ğŸš—</div><h3>Corridas Hoje</h3><div class="value" id="corridasHoje">0</div></div>
                    <div class="card orange"><div class="card-icon">â³</div><h3>Pendentes</h3><div class="value" id="corridasPendentes">0</div></div>
                    <div class="card green"><div class="card-icon">ğŸ’°</div><h3>Faturamento</h3><div class="value">R$ <span id="faturamentoHoje">0</span></div></div>
                    <div class="card red"><div class="card-icon">ğŸ›¡ï¸</div><h3>Alertas Fraude</h3><div class="value" id="alertasFraude">0</div></div>
                </div>
                <div class="panel-grid">
                    <div class="panel"><h2>ğŸ“ˆ Corridas - 7 dias</h2><div class="chart-container"><canvas id="chartCorridas"></canvas></div></div>
                    <div class="panel"><h2>â° HorÃ¡rios de Pico</h2><div id="horariosPico"></div></div>
                </div>
                <div class="panel-grid">
                    <div class="panel"><h2>ğŸ† Top 5 Motoristas</h2><div id="topMotoristas"></div></div>
                    <div class="panel"><h2>ğŸ”” Corridas Ativas</h2><table><thead><tr><th>Cliente</th><th>Motorista</th><th>Status</th><th>AÃ§Ã£o</th></tr></thead><tbody id="corridasAtivasTable"></tbody></table></div>
                </div>
            </div>

            <!-- MAPA -->
            <div id="mapa" class="page">
                <h2 style="margin-bottom:20px;">ğŸ—ºï¸ Mapa em Tempo Real</h2>
                <div class="cards">
                    <div class="card green"><h3>DisponÃ­veis</h3><div class="value" id="mapaDisponiveis">0</div></div>
                    <div class="card blue"><h3>Em Corrida</h3><div class="value" id="mapaEmCorrida">0</div></div>
                    <div class="card red"><h3>Offline</h3><div class="value" id="mapaOffline">0</div></div>
                </div>
                <div class="panel"><div id="mapaLeaflet"></div></div>
            </div>

            <!-- CORRIDAS -->
            <div id="corridas" class="page">
                <h2 style="margin-bottom:20px;">ğŸš— Corridas</h2>
                <div class="search-bar">
                    <select id="filtroCorrida"><option value="">Todos</option><option value="pendente">Pendente</option><option value="aceita">Aceita</option><option value="finalizada">Finalizada</option><option value="cancelada">Cancelada</option></select>
                    <button class="btn btn-primary" onclick="carregarCorridas()">ğŸ”</button>
                </div>
                <div class="panel"><table><thead><tr><th>ID</th><th>Cliente</th><th>Origem</th><th>Destino</th><th>Valor</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="corridasTable"></tbody></table></div>
            </div>

            <!-- DESPACHO -->
            <div id="despacho" class="page">
                <h2 style="margin-bottom:20px;">ğŸ“¡ Central de Despacho</h2>
                <div class="cards">
                    <div class="card blue"><h3>Modo Atual</h3><div class="value" id="modoDespachoAtual">-</div></div>
                    <div class="card orange"><h3>Aguardando</h3><div class="value" id="aguardandoAceite">0</div></div>
                    <div class="card green"><h3>Aceitas</h3><div class="value" id="aceitasHoje">0</div></div>
                    <div class="card purple"><h3>Online</h3><div class="value" id="motoristasDespacho">0</div></div>
                </div>
                <div class="panel">
                    <h2>âš™ï¸ Modo de Despacho</h2>
                    <div class="modo-card" id="modoBroadcast" onclick="setModoDespacho('broadcast')"><h3><span class="modo-icon">ğŸ“¢</span> Broadcast</h3><p>Envia para TODOS, primeiro aceita.</p></div>
                    <div class="modo-card" id="modoProximo" onclick="setModoDespacho('proximo')"><h3><span class="modo-icon">ğŸ“</span> Mais PrÃ³ximo</h3><p>Envia para o mais perto do cliente.</p></div>
                    <div class="form-group" style="margin-top:15px;"><label>Tempo aceite (seg)</label><input type="number" id="tempoAceite" value="30" style="width:100px;"><button class="btn btn-primary" onclick="salvarTempoAceite()" style="margin-left:10px;">Salvar</button></div>
                </div>
                <div class="panel"><h2>ğŸš— Pendentes</h2><div id="corridasPendentesDespacho"></div></div>
            </div>

            <!-- MOTORISTAS -->
            <div id="motoristas" class="page">
                <h2 style="margin-bottom:20px;">ğŸ‘¨â€âœˆï¸ Motoristas</h2>
                <div class="search-bar">
                    <input type="text" id="buscaMotorista" placeholder="Buscar...">
                    <select id="filtroStatusMotorista"><option value="">Todos</option><option value="disponivel">DisponÃ­vel</option><option value="em_corrida">Em Corrida</option><option value="offline">Offline</option></select>
                    <button class="btn btn-primary" onclick="carregarMotoristas()">ğŸ”</button>
                    <button class="btn btn-success" onclick="abrirModalMotorista()">+ Novo</button>
                </div>
                <div class="panel"><table><thead><tr><th>Nome</th><th>WhatsApp</th><th>VeÃ­culo</th><th>Placa</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="motoristasTable"></tbody></table></div>
            </div>

            <!-- CLIENTES -->
            <div id="clientes" class="page">
                <h2 style="margin-bottom:20px;">ğŸ‘¥ Clientes</h2>
                <div class="search-bar">
                    <input type="text" id="buscaCliente" placeholder="Buscar...">
                    <button class="btn btn-primary" onclick="carregarClientes()">ğŸ”</button>
                    <button class="btn btn-success" onclick="abrirModalCliente()">+ Novo</button>
                </div>
                <div class="panel"><table><thead><tr><th>Nome</th><th>Telefone</th><th>Corridas</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="clientesTable"></tbody></table></div>
            </div>

            <!-- ROTAS -->
            <div id="rotas" class="page">
                <h2 style="margin-bottom:20px;">ğŸ“ Calcular Rota</h2>
                <div class="panel">
                    <div class="form-row">
                        <div class="form-group"><label>Origem</label><input type="text" id="rotaOrigem" placeholder="Rua das Flores, 123 - Osasco"></div>
                        <div class="form-group"><label>Destino</label><input type="text" id="rotaDestino" placeholder="Av. Brasil, 456 - SÃ£o Paulo"></div>
                    </div>
                    <button class="btn btn-primary" onclick="calcularRota()">ğŸ“ Calcular</button>
                    <button class="btn btn-success" onclick="encontrarMotoristaProximo()">ğŸš— Motorista PrÃ³ximo</button>
                    <div id="resultadoRota" class="rota-info" style="display:none;">
                        <div class="rota-detalhe"><span>DistÃ¢ncia:</span><strong id="rotaDistancia">-</strong></div>
                        <div class="rota-detalhe"><span>Tempo:</span><strong id="rotaTempo">-</strong></div>
                        <div class="rota-detalhe"><span>ğŸ’° Valor:</span><strong id="rotaPreco" style="color:#27ae60;font-size:1.3em;">-</strong></div>
                        <div class="rota-detalhe"><span>Faixa:</span><strong id="rotaFaixa">-</strong></div>
                        <div class="rota-detalhe"><span>Tipo:</span><strong id="rotaTipo">-</strong></div>
                    </div>
                    <div id="motoristaProximo" class="rota-info" style="display:none;"><div id="motoristaProximoInfo"></div></div>
                </div>
                <div class="panel"><div id="mapaGoogle"></div></div>
            </div>

            <!-- FATURAMENTO -->
            <div id="faturamento" class="page">
                <h2 style="margin-bottom:20px;">ğŸ’° Faturamento</h2>
                <div class="cards">
                    <div class="card green"><h3>Hoje</h3><div class="value">R$ <span id="fatHoje">0</span></div></div>
                    <div class="card blue"><h3>Semana</h3><div class="value">R$ <span id="fatSemana">0</span></div></div>
                    <div class="card purple"><h3>MÃªs</h3><div class="value">R$ <span id="fatMes">0</span></div></div>
                    <div class="card orange"><h3>ComissÃ£o</h3><div class="value">R$ <span id="fatComissao">0</span></div></div>
                </div>
                <div class="panel"><h2>ğŸ“ˆ Faturamento - 30 dias</h2><div class="chart-container"><canvas id="chartFaturamento"></canvas></div></div>
            </div>

            <!-- PREÃ‡OS DINÃ‚MICOS -->
            <div id="precos" class="page">
                <h2 style="margin-bottom:20px;">ğŸ’µ PreÃ§os DinÃ¢micos</h2>
                
                <div class="cards">
                    <div class="card green"><h3>Taxa Base</h3><div class="value">R$ <span id="precoTaxaBase">5.00</span></div></div>
                    <div class="card blue"><h3>PreÃ§o/Km</h3><div class="value">R$ <span id="precoKmAtual">2.50</span></div></div>
                    <div class="card orange"><h3>MÃ­nimo</h3><div class="value">R$ <span id="precoMinimo">15.00</span></div></div>
                    <div class="card purple"><h3>Faixa Atual</h3><div class="value" id="faixaAtualNome">Normal</div></div>
                </div>

                <div class="panel">
                    <h2>ğŸ’° Valores Base</h2>
                    <div class="form-row">
                        <div class="form-group"><label>Taxa Base (R$)</label><input type="number" id="taxaBase" step="0.01" value="5.00"></div>
                        <div class="form-group"><label>PreÃ§o/Km (R$)</label><input type="number" id="precoKm" step="0.01" value="2.50"></div>
                        <div class="form-group"><label>Taxa MÃ­nima (R$)</label><input type="number" id="taxaMinima" step="0.01" value="15.00"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Taxa Bandeira 2 (R$)</label><input type="number" id="taxaBandeira2" step="0.01" value="3.00"></div>
                        <div class="form-group"><label>PreÃ§o/Minuto Parado (R$)</label><input type="number" id="precoMinuto" step="0.01" value="0.50"></div>
                    </div>
                    <button class="btn btn-success" onclick="salvarConfigPreco()">ğŸ’¾ Salvar Valores Base</button>
                </div>

                <div class="panel">
                    <h2>â° Faixas de HorÃ¡rio por Dia</h2>
                    <p style="color:#666;margin-bottom:15px;">Configure preÃ§os <strong>FIXOS</strong> ou com <strong>MULTIPLICADOR</strong> para cada horÃ¡rio.</p>
                    
                    <div class="tabs" id="tabsDias">
                        <button class="tab active" onclick="selecionarDia('segunda')">Seg</button>
                        <button class="tab" onclick="selecionarDia('terca')">Ter</button>
                        <button class="tab" onclick="selecionarDia('quarta')">Qua</button>
                        <button class="tab" onclick="selecionarDia('quinta')">Qui</button>
                        <button class="tab" onclick="selecionarDia('sexta')">Sex</button>
                        <button class="tab" onclick="selecionarDia('sabado')">SÃ¡b</button>
                        <button class="tab" onclick="selecionarDia('domingo')">Dom</button>
                    </div>

                    <div style="margin-bottom:15px;">
                        <button class="btn btn-success" onclick="abrirModalFaixa()">+ Nova Faixa</button>
                        <button class="btn btn-purple" onclick="abrirModalCopiarFaixas()">ğŸ“‹ Copiar Faixas</button>
                    </div>

                    <div id="faixasHorario"></div>
                </div>

                <div class="panel">
                    <h2>ğŸ§® Simulador de PreÃ§o</h2>
                    <div class="form-row">
                        <div class="form-group"><label>DistÃ¢ncia (km)</label><input type="number" id="simularKm" value="5" step="0.1"></div>
                        <div class="form-group"><label>Dia</label><select id="simularDia"><option value="segunda">Segunda</option><option value="terca">TerÃ§a</option><option value="quarta">Quarta</option><option value="quinta">Quinta</option><option value="sexta">Sexta</option><option value="sabado">SÃ¡bado</option><option value="domingo">Domingo</option></select></div>
                    </div>
                    <button class="btn btn-primary" onclick="simularPrecos()">ğŸ§® Simular Todas Faixas</button>
                    <div id="resultadoSimulacao" style="margin-top:15px;"></div>
                </div>
            </div>

            <!-- RANKING -->
            <div id="ranking" class="page">
                <h2 style="margin-bottom:20px;">ğŸ† Ranking</h2>
                <div class="search-bar"><select id="rankingPeriodo" onchange="carregarRanking()"><option value="semana">Semana</option><option value="mes" selected>MÃªs</option><option value="ano">Ano</option></select></div>
                <div class="panel"><div id="rankingLista"></div></div>
            </div>

            <!-- ANTI-FRAUDE -->
            <div id="antifraude" class="page">
                <h2 style="margin-bottom:20px;">ğŸ›¡ï¸ Anti-Fraude</h2>
                <div class="cards">
                    <div class="card red"><h3>CrÃ­ticos</h3><div class="value" id="fraudeCriticos">0</div></div>
                    <div class="card orange"><h3>Altos</h3><div class="value" id="fraudeAltos">0</div></div>
                    <div class="card yellow"><h3>Pendentes</h3><div class="value" id="fraudePendentes">0</div></div>
                    <div class="card green"><h3>Resolvidos</h3><div class="value" id="fraudeResolvidos">0</div></div>
                </div>
                <div class="search-bar"><select id="filtroFraudeStatus"><option value="">Todos</option><option value="pendente">Pendentes</option><option value="resolvido">Resolvidos</option></select><button class="btn btn-primary" onclick="carregarAntiFraude()">ğŸ”</button></div>
                <div class="panel"><div id="alertasFraudeLista"></div></div>
            </div>

            <!-- BLACKLIST -->
            <div id="blacklist" class="page">
                <h2 style="margin-bottom:20px;">ğŸš« Blacklist</h2>
                <div class="cards">
                    <div class="card red"><h3>Total</h3><div class="value" id="blacklistTotal">0</div></div>
                    <div class="card orange"><h3>Telefones</h3><div class="value" id="blacklistTelefones">0</div></div>
                    <div class="card purple"><h3>CPFs</h3><div class="value" id="blacklistCPFs">0</div></div>
                </div>
                <button class="btn btn-danger" onclick="abrirModalBlacklist()" style="margin-bottom:20px;">+ Adicionar</button>
                <div class="panel"><table><thead><tr><th>Tipo</th><th>Valor</th><th>Motivo</th><th>Data</th><th>AÃ§Ãµes</th></tr></thead><tbody id="blacklistTable"></tbody></table></div>
            </div>

            <!-- RECLAMAÃ‡Ã•ES -->
            <div id="reclamacoes" class="page">
                <h2 style="margin-bottom:20px;">ğŸ“ ReclamaÃ§Ãµes</h2>
                <div class="cards">
                    <div class="card red"><h3>Pendentes</h3><div class="value" id="recPendentes">0</div></div>
                    <div class="card yellow"><h3>Andamento</h3><div class="value" id="recAndamento">0</div></div>
                    <div class="card green"><h3>Resolvidas</h3><div class="value" id="recResolvidas">0</div></div>
                </div>
                <div class="search-bar"><select id="filtroReclamacao"><option value="">Todas</option><option value="pendente">Pendentes</option><option value="resolvida">Resolvidas</option></select><button class="btn btn-primary" onclick="carregarReclamacoes()">ğŸ”</button><button class="btn btn-success" onclick="abrirModalReclamacao()">+ Nova</button></div>
                <div class="panel"><table><thead><tr><th>Data</th><th>Cliente</th><th>Assunto</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="reclamacoesTable"></tbody></table></div>
            </div>

            <!-- WHATSAPP -->
            <div id="whatsapp" class="page">
                <h2 style="margin-bottom:20px;">ğŸ’¬ WhatsApp - Rebeca IA</h2>
                
                <div class="cards">
                    <div class="card" id="cardStatusWpp">
                        <div class="card-icon">ğŸ“±</div>
                        <h3>Status</h3>
                        <div class="value" id="wppStatusText" style="font-size:1em;">Desconectado</div>
                    </div>
                    <div class="card green">
                        <div class="card-icon">ğŸ¤–</div>
                        <h3>Rebeca IA</h3>
                        <div class="value" style="font-size:1em;">Pronta</div>
                    </div>
                    <div class="card blue">
                        <div class="card-icon">ğŸ‘¨â€âœˆï¸</div>
                        <h3>Motoristas</h3>
                        <div class="value" id="wppMotoristas">0</div>
                    </div>
                    <div class="card purple">
                        <div class="card-icon">ğŸ’¬</div>
                        <h3>Msgs Hoje</h3>
                        <div class="value" id="wppMsgsHoje">0</div>
                    </div>
                </div>

                <div class="panel-grid">
                    <div class="panel" style="text-align:center;">
                        <h2>ğŸ“± Conectar WhatsApp</h2>
                        <p style="color:#666;margin-bottom:20px;">Escaneie o QR Code com seu WhatsApp Business</p>
                        
                        <div id="qrCodeBox" style="background:#fff;padding:20px;border-radius:15px;min-height:280px;display:flex;justify-content:center;align-items:center;flex-direction:column;margin-bottom:20px;">
                            <p style="color:#333;">Clique no botao abaixo para gerar o QR Code</p>
                        </div>
                        
                        <div id="wppStatusBadge" style="padding:12px;border-radius:8px;margin-bottom:20px;background:#f8d7da;color:#721c24;font-weight:bold;">
                            ğŸ”´ Desconectado
                        </div>
                        
                        <button class="btn btn-success" onclick="gerarQRCodeAdmin()" id="btnGerarQR" style="font-size:1.1em;padding:15px 30px;">
                            ğŸ“· Gerar QR Code
                        </button>
                        <button class="btn btn-danger" onclick="desconectarWhatsApp()" id="btnDesconectar" style="display:none;font-size:1.1em;padding:15px 30px;">
                            ğŸ”Œ Desconectar
                        </button>
                    </div>
                    
                    <div class="panel">
                        <h2>ğŸ¤– Rebeca - Assistente IA</h2>
                        <div style="background:#f0fff4;padding:20px;border-radius:10px;margin-bottom:20px;">
                            <h3 style="color:#27ae60;margin-bottom:10px;">âœ… Funcionalidades Ativas</h3>
                            <ul style="color:#666;line-height:2;">
                                <li>ğŸ“ Receber pedidos de corrida via WhatsApp</li>
                                <li>ğŸš— Despachar corridas para motoristas</li>
                                <li>ğŸ“Š Informar status da corrida ao cliente</li>
                                <li>ğŸ’° Calcular precos automaticamente</li>
                                <li>â­ Coletar avaliacoes pos-corrida</li>
                                <li>â“ Responder duvidas dos clientes</li>
                            </ul>
                        </div>
                        
                        <h3 style="margin-bottom:10px;">ğŸ“‹ Como Funciona:</h3>
                        <ol style="color:#666;line-height:2;padding-left:20px;">
                            <li>Conecte seu WhatsApp Business</li>
                            <li>A Rebeca comeca a atender automaticamente</li>
                            <li>Clientes enviam localizacao para pedir corrida</li>
                            <li>Rebeca encontra motorista e despacha</li>
                            <li>Acompanhe tudo pelo painel</li>
                        </ol>
                    </div>
                </div>
                
                <div class="panel" style="display:none;">
                    <h2>âš™ï¸ Configuracoes Evolution API</h2>
                    <div class="form-row">
                        <div class="form-group"><label>URL da API</label><input type="text" id="whatsappApiUrl" placeholder="http://localhost:8080"></div>
                        <div class="form-group"><label>API Key</label><input type="password" id="whatsappApiKey" placeholder="Sua chave da API"></div>
                        <div class="form-group"><label>Nome da Instancia</label><input type="text" id="whatsappInstancia" value="rebeca-taxi"></div>
                    </div>
                    <button class="btn btn-success" onclick="salvarConfigWhatsApp()">ğŸ’¾ Salvar Configuracoes</button>
                </div>
            </div>

            <!-- USUÃRIOS -->
            <div id="usuarios" class="page">
                <h2 style="margin-bottom:20px;">ğŸ‘¤ UsuÃ¡rios Admin</h2>
                <div class="cards">
                    <div class="card blue"><h3>Total</h3><div class="value" id="usrTotal">0</div></div>
                    <div class="card green"><h3>Ativos</h3><div class="value" id="usrAtivos">0</div></div>
                    <div class="card purple"><h3>SessÃµes</h3><div class="value" id="usrSessoes">0</div></div>
                </div>
                <button class="btn btn-success" onclick="abrirModalUsuario()" style="margin-bottom:20px;">+ Novo</button>
                <div class="panel"><table><thead><tr><th>Nome</th><th>Login</th><th>Email</th><th>NÃ­vel</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="usuariosTable"></tbody></table></div>
            </div>

            <!-- ÃREAS -->
            <div id="areas" class="page">
                <h2 style="margin-bottom:20px;">ğŸ—ºï¸ Ãreas de Cobertura</h2>
                <button class="btn btn-success" onclick="abrirModalArea()" style="margin-bottom:20px;">+ Nova</button>
                <div class="panel"><table><thead><tr><th>Nome</th><th>Cidade</th><th>Bairros</th><th>Taxa</th><th>AÃ§Ãµes</th></tr></thead><tbody id="areasTable"></tbody></table></div>
            </div>

            <!-- CONFIG -->
            <div id="config" class="page">
                <h2 style="margin-bottom:20px;">âš™ï¸ ConfiguraÃ§Ãµes</h2>
                <div class="panel">
                    <h2>Tempos e Limites</h2>
                    <div class="form-row">
                        <div class="form-group"><label>Tempo Espera (min)</label><input type="number" id="cfgTempoEspera" value="10"></div>
                        <div class="form-group"><label>Raio Busca (km)</label><input type="number" id="cfgRaioBusca" value="15"></div>
                        <div class="form-group"><label>ComissÃ£o (%)</label><input type="number" id="cfgComissao" value="15"></div>
                    </div>
                    <button class="btn btn-success" onclick="salvarConfiguracoes()">ğŸ’¾ Salvar</button>
                </div>
            </div>

            <!-- LOGS -->
            <div id="logs" class="page">
                <h2 style="margin-bottom:20px;">ğŸ“œ Logs</h2>
                <div class="cards">
                    <div class="card blue"><h3>Total</h3><div class="value" id="logTotal">0</div></div>
                    <div class="card green"><h3>Hoje</h3><div class="value" id="logHoje">0</div></div>
                    <div class="card red"><h3>Erros</h3><div class="value" id="logErros">0</div></div>
                </div>
                <div class="search-bar"><select id="filtroLogTipo"><option value="">Todos</option><option value="login">Login</option><option value="config">Config</option><option value="despacho">Despacho</option></select><button class="btn btn-primary" onclick="carregarLogs()">ğŸ”</button></div>
                <div class="panel"><div id="logsLista"></div></div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <div class="modal" id="modalMotorista"><div class="modal-content"><div class="modal-header"><h3>ğŸ“‹ Novo Motorista</h3><button class="modal-close" onclick="fecharModal('modalMotorista')">&times;</button></div><div id="formMotoristaAlert"></div><form id="formMotorista"><div class="form-group"><label>Nome *</label><input type="text" id="motNome" required></div><div class="form-row"><div class="form-group"><label>WhatsApp *</label><input type="text" id="motWhatsApp" required></div><div class="form-group"><label>CPF</label><input type="text" id="motCPF"></div></div><div class="form-row"><div class="form-group"><label>CNH *</label><input type="text" id="motCNH" required></div><div class="form-group"><label>Validade</label><input type="date" id="motCNHValidade"></div></div><hr class="divider"><div class="form-row"><div class="form-group"><label>Modelo *</label><input type="text" id="motVeiculoModelo" required></div><div class="form-group"><label>Cor *</label><input type="text" id="motVeiculoCor" required></div></div><div class="form-row"><div class="form-group"><label>Placa *</label><input type="text" id="motVeiculoPlaca" required></div><div class="form-group"><label>Ano</label><input type="number" id="motVeiculoAno"></div></div><button type="submit" class="btn btn-success" style="width:100%;padding:12px;">âœ… Cadastrar</button></form><div id="tokenMotoristaBox" class="token-box" style="display:none;"><h4>ğŸ‰ Cadastrado!</h4><code id="tokenGerado"></code><p>Senha: <span id="senhaGerada"></span></p></div></div></div>

    <div class="modal" id="modalCliente"><div class="modal-content"><div class="modal-header"><h3>Novo Cliente</h3><button class="modal-close" onclick="fecharModal('modalCliente')">&times;</button></div><form id="formCliente"><div class="form-group"><label>Nome</label><input type="text" id="cliNome" required></div><div class="form-group"><label>WhatsApp</label><input type="text" id="cliTelefone" required></div><button type="submit" class="btn btn-success" style="width:100%;">Salvar</button></form></div></div>

    <div class="modal" id="modalReclamacao"><div class="modal-content"><div class="modal-header"><h3>ğŸ“ Nova ReclamaÃ§Ã£o</h3><button class="modal-close" onclick="fecharModal('modalReclamacao')">&times;</button></div><form id="formReclamacao"><div class="form-row"><div class="form-group"><label>Cliente</label><input type="text" id="recClienteNome" required></div><div class="form-group"><label>Telefone</label><input type="text" id="recClienteTel" required></div></div><div class="form-group"><label>Assunto</label><input type="text" id="recAssunto" required></div><div class="form-group"><label>DescriÃ§Ã£o</label><textarea id="recDescricao" rows="3"></textarea></div><button type="submit" class="btn btn-success" style="width:100%;">ğŸ“© Registrar</button></form></div></div>

    <div class="modal" id="modalArea"><div class="modal-content"><div class="modal-header"><h3>ğŸ—ºï¸ Nova Ãrea</h3><button class="modal-close" onclick="fecharModal('modalArea')">&times;</button></div><form id="formArea"><div class="form-group"><label>Nome</label><input type="text" id="areaNome" required></div><div class="form-group"><label>Cidade</label><input type="text" id="areaCidade" required></div><div class="form-group"><label>Bairros</label><input type="text" id="areaBairros" placeholder="Separados por vÃ­rgula"></div><div class="form-group"><label>Taxa Extra</label><input type="number" id="areaTaxa" step="0.01" value="0"></div><button type="submit" class="btn btn-success" style="width:100%;">ğŸ’¾ Salvar</button></form></div></div>

    <div class="modal" id="modalBlacklist"><div class="modal-content"><div class="modal-header"><h3>ğŸš« Blacklist</h3><button class="modal-close" onclick="fecharModal('modalBlacklist')">&times;</button></div><form id="formBlacklist"><div class="form-group"><label>Tipo</label><select id="blTipo"><option value="telefone">Telefone</option><option value="cpf">CPF</option></select></div><div class="form-group"><label>Valor</label><input type="text" id="blValor" required></div><div class="form-group"><label>Motivo</label><textarea id="blMotivo" rows="2" required></textarea></div><button type="submit" class="btn btn-danger" style="width:100%;">ğŸš« Bloquear</button></form></div></div>

    <div class="modal" id="modalUsuario"><div class="modal-content"><div class="modal-header"><h3>ğŸ‘¤ Novo UsuÃ¡rio</h3><button class="modal-close" onclick="fecharModal('modalUsuario')">&times;</button></div><div id="formUsuarioAlert"></div><form id="formUsuario"><div class="form-group"><label>Nome *</label><input type="text" id="usrNome" required></div><div class="form-row"><div class="form-group"><label>Login *</label><input type="text" id="usrLogin" required></div><div class="form-group"><label>Email *</label><input type="email" id="usrEmail" required></div></div><div class="form-row"><div class="form-group"><label>Senha</label><input type="text" id="usrSenha" placeholder="Vazio = 123456"></div><div class="form-group"><label>NÃ­vel</label><select id="usrNivel"><option value="admin">Admin</option><option value="gerente">Gerente</option><option value="operador" selected>Operador</option><option value="financeiro">Financeiro</option></select></div></div><button type="submit" class="btn btn-success" style="width:100%;padding:12px;">âœ… Criar</button></form><div id="usuarioCriado" class="token-box" style="display:none;"><h4>ğŸ‰ Criado!</h4><p>Login: <strong id="novoUsrLogin"></strong></p><p>Senha: <strong id="novoUsrSenha"></strong></p></div></div></div>

    <!-- MODAL FAIXA COM OPÃ‡ÃƒO FIXO/MULTIPLICADOR -->
    <div class="modal" id="modalFaixa">
        <div class="modal-content">
            <div class="modal-header"><h3>â° Nova Faixa de HorÃ¡rio</h3><button class="modal-close" onclick="fecharModal('modalFaixa')">&times;</button></div>
            <form id="formFaixa">
                <div class="form-group"><label>Nome da Faixa</label><input type="text" id="faixaNome" placeholder="Ex: Madrugada, Pico ManhÃ£" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Hora InÃ­cio</label><input type="time" id="faixaInicio" required></div>
                    <div class="form-group"><label>Hora Fim</label><input type="time" id="faixaFim" required></div>
                </div>
                
                <label style="font-weight:500;margin-bottom:10px;display:block;">Tipo de PreÃ§o:</label>
                <div class="tipo-preco">
                    <div class="tipo-preco-btn active" id="tipoMult" onclick="selecionarTipoPreco('multiplicador')">
                        <h4>ğŸ“Š Multiplicador</h4>
                        <p>PreÃ§o calculado x fator</p>
                    </div>
                    <div class="tipo-preco-btn" id="tipoFixo" onclick="selecionarTipoPreco('fixo')">
                        <h4>ğŸ’µ Valor Fixo</h4>
                        <p>PreÃ§o tabelado (ex: R$30)</p>
                    </div>
                </div>
                
                <!-- Campos para MULTIPLICADOR -->
                <div id="camposMultiplicador" class="campos-tipo active">
                    <div class="form-row">
                        <div class="form-group"><label>Multiplicador</label><input type="number" id="faixaMult" step="0.1" value="1.0" min="0.5" max="3.0"></div>
                        <div class="form-group"><label>Taxa Adicional (R$)</label><input type="number" id="faixaTaxa" step="0.50" value="0" min="0"></div>
                    </div>
                    <div class="alert alert-info">ğŸŸ¢ 1.0x = Normal | ğŸŸ¡ 1.2-1.3x = Moderado | ğŸ”´ 1.5x+ = Alta demanda</div>
                </div>
                
                <!-- Campos para VALOR FIXO -->
                <div id="camposFixo" class="campos-tipo">
                    <div class="form-group">
                        <label>ğŸ’µ Valor Fixo (R$)</label>
                        <input type="number" id="faixaValorFixo" step="1" value="30" min="1" style="font-size:1.2em;font-weight:bold;">
                    </div>
                    <div class="alert alert-success">ğŸ’¡ O cliente pagarÃ¡ exatamente este valor, independente da distÃ¢ncia.</div>
                </div>
                
                <input type="hidden" id="faixaTipo" value="multiplicador">
                
                <button type="submit" class="btn btn-success" style="width:100%;margin-top:15px;">ğŸ’¾ Salvar Faixa</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modalCopiarFaixas"><div class="modal-content"><div class="modal-header"><h3>ğŸ“‹ Copiar Faixas</h3><button class="modal-close" onclick="fecharModal('modalCopiarFaixas')">&times;</button></div><div class="form-group"><label>Copiar de</label><select id="copiarOrigem"><option value="segunda">Segunda</option><option value="terca">TerÃ§a</option><option value="quarta">Quarta</option><option value="quinta">Quinta</option><option value="sexta">Sexta</option><option value="sabado">SÃ¡bado</option><option value="domingo">Domingo</option></select></div><div class="form-group"><label>Para</label><select id="copiarDestino"><option value="segunda">Segunda</option><option value="terca">TerÃ§a</option><option value="quarta">Quarta</option><option value="quinta">Quinta</option><option value="sexta">Sexta</option><option value="sabado">SÃ¡bado</option><option value="domingo">Domingo</option></select></div><button class="btn btn-purple" onclick="copiarFaixas()" style="width:100%;">ğŸ“‹ Copiar</button></div></div>

    <!-- MODAL EDITAR FAIXA -->
    <div class="modal" id="modalEditarFaixa">
        <div class="modal-content">
            <div class="modal-header"><h3>âœï¸ Editar Faixa</h3><button class="modal-close" onclick="fecharModal('modalEditarFaixa')">&times;</button></div>
            <form id="formEditarFaixa">
                <input type="hidden" id="editFaixaId">
                <div class="form-group"><label>Nome</label><input type="text" id="editFaixaNome" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Hora InÃ­cio</label><input type="time" id="editFaixaInicio" required></div>
                    <div class="form-group"><label>Hora Fim</label><input type="time" id="editFaixaFim" required></div>
                </div>
                
                <label style="font-weight:500;margin-bottom:10px;display:block;">Tipo de PreÃ§o:</label>
                <div class="tipo-preco">
                    <div class="tipo-preco-btn" id="editTipoMult" onclick="selecionarTipoPrecoEdit('multiplicador')">
                        <h4>ğŸ“Š Multiplicador</h4>
                    </div>
                    <div class="tipo-preco-btn" id="editTipoFixo" onclick="selecionarTipoPrecoEdit('fixo')">
                        <h4>ğŸ’µ Valor Fixo</h4>
                    </div>
                </div>
                
                <div id="editCamposMultiplicador" class="campos-tipo">
                    <div class="form-row">
                        <div class="form-group"><label>Multiplicador</label><input type="number" id="editFaixaMult" step="0.1" value="1.0"></div>
                        <div class="form-group"><label>Taxa Adicional (R$)</label><input type="number" id="editFaixaTaxa" step="0.50" value="0"></div>
                    </div>
                </div>
                
                <div id="editCamposFixo" class="campos-tipo">
                    <div class="form-group"><label>ğŸ’µ Valor Fixo (R$)</label><input type="number" id="editFaixaValorFixo" step="1" value="30"></div>
                </div>
                
                <input type="hidden" id="editFaixaTipo" value="multiplicador">
                
                <button type="submit" class="btn btn-success" style="width:100%;margin-top:15px;">ğŸ’¾ Salvar</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app.js"></script>
<script src="mensalidades.js"></script>
<script src="emergencia.js"></script>
</body>
</html>

<!-- Inserir antes do </main> - PÃ¡gina Config Rebeca -->
<script>
// Adicionar pÃ¡gina Rebeca dinamicamente
const paginaRebeca = document.createElement('div');
paginaRebeca.id = 'rebeca';
paginaRebeca.className = 'page';
paginaRebeca.innerHTML = `
    <h2 style="margin-bottom:20px;">ğŸ¤– ConfiguraÃ§Ãµes Rebeca</h2>
    
    <div class="cards">
        <div class="card blue"><h3>Conversas Ativas</h3><div class="value" id="rebecaConversas">0</div></div>
        <div class="card green"><h3>Corridas via Rebeca</h3><div class="value" id="rebecaCorridas">0</div></div>
        <div class="card purple"><h3>Auto-Detect</h3><div class="value" id="rebecaAutoDetect">ON</div></div>
    </div>

    <div class="panel">
        <h2>âš™ï¸ Comportamento da Rebeca</h2>
        <p style="color:#666;margin-bottom:20px;">Configure como a Rebeca interage com os clientes.</p>
        
        <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input type="checkbox" id="cfgAutoDetectar" checked style="width:20px;height:20px;">
                <span><strong>ğŸ” Auto-detectar endereÃ§o</strong><br><small style="color:#666;">Quando cliente envia sÃ³ o endereÃ§o, Rebeca pergunta se quer chamar carro</small></span>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input type="checkbox" id="cfgEnviarLink" checked style="width:20px;height:20px;">
                <span><strong>ğŸ“² Enviar link de rastreamento</strong><br><small style="color:#666;">Cliente recebe link para acompanhar motorista no mapa</small></span>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input type="checkbox" id="cfgNotificarTempo" checked style="width:20px;height:20px;">
                <span><strong>ğŸ”” Notificar tempo do motorista</strong><br><small style="color:#666;">Avisar cliente: "3 min", "1 min", "chegou"</small></span>
            </label>
        </div>
        
        <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input type="checkbox" id="cfgBoaViagem" checked style="width:20px;height:20px;">
                <span><strong>ğŸš€ Mensagem "Boa Viagem"</strong><br><small style="color:#666;">Enviar quando corrida iniciar</small></span>
            </label>
        </div>
        
        <button class="btn btn-success" onclick="salvarConfigRebeca()" style="margin-top:15px;">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
    </div>

    <div class="panel">
        <h2>ğŸ§ª Testar Rebeca</h2>
        <p style="color:#666;margin-bottom:15px;">Simule uma conversa para testar.</p>
        
        <div class="form-group">
            <label>Telefone (simulado)</label>
            <input type="text" id="testeRebecaTel" value="11999998888">
        </div>
        <div class="form-group">
            <label>Mensagem</label>
            <input type="text" id="testeRebecaMsg" placeholder="Ex: Avenida Rio de Janeiro, 2981">
        </div>
        <button class="btn btn-primary" onclick="testarRebeca()">ğŸ“¤ Enviar Mensagem</button>
        
        <div id="testeRebecaResposta" style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:10px;white-space:pre-wrap;display:none;"></div>
    </div>

    <div class="panel">
        <h2>ğŸ“ Exemplo de Fluxo RÃ¡pido</h2>
        <div style="background:#e8f5e9;padding:15px;border-radius:10px;font-family:monospace;font-size:0.9em;">
            <p><strong>Cliente:</strong> Avenida Rio de Janeiro, 2981</p>
            <p style="color:#27ae60;margin:10px 0;"><strong>Rebeca:</strong> ğŸ“ VocÃª estÃ¡ em:<br>*Avenida Rio de Janeiro, 2981*?<br><br>*1* - âœ… Sim, chamar carro aqui<br>*2* - ğŸ“ NÃ£o, quero digitar outro<br>*3* - ğŸ’° SÃ³ quero cotaÃ§Ã£o</p>
            <p><strong>Cliente:</strong> 1</p>
            <p style="color:#27ae60;margin:10px 0;"><strong>Rebeca:</strong> âœ… Origem confirmada!<br>ğŸ Agora envie o *destino*:</p>
            <p><strong>Cliente:</strong> Shopping Center Norte</p>
            <p style="color:#27ae60;margin:10px 0;"><strong>Rebeca:</strong> ğŸš— *CARRO SOLICITADO!*<br>ğŸ“ De: Av Rio de Janeiro, 2981<br>ğŸ Para: Shopping Center Norte<br>ğŸ’° Valor: R$ 25,00<br><br>ğŸ“² Acompanhe: https://..../rastrear/abc123</p>
        </div>
    </div>
`;
document.querySelector('.main-content').appendChild(paginaRebeca);

// Adicionar item no menu
const menuRebeca = document.createElement('div');
menuRebeca.className = 'menu-item';
menuRebeca.setAttribute('data-page', 'rebeca');
menuRebeca.innerHTML = 'ğŸ¤– Rebeca';
document.querySelector('.sidebar').insertBefore(menuRebeca, document.querySelector('[data-page="whatsapp"]'));

menuRebeca.addEventListener('click', () => {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    menuRebeca.classList.add('active');
    document.getElementById('rebeca').classList.add('active');
    carregarConfigRebeca();
});

// FunÃ§Ãµes
async function carregarConfigRebeca() {
    const cfg = await api('/api/rebeca/config');
    document.getElementById('cfgAutoDetectar').checked = cfg.autoDetectarEndereco !== false;
    document.getElementById('cfgEnviarLink').checked = cfg.enviarLinkRastreamento !== false;
    document.getElementById('cfgNotificarTempo').checked = cfg.notificarTempoMotorista !== false;
    document.getElementById('cfgBoaViagem').checked = cfg.mensagemBoaViagem !== false;
    document.getElementById('rebecaAutoDetect').textContent = cfg.autoDetectarEndereco !== false ? 'ON' : 'OFF';
}

async function salvarConfigRebeca() {
    const cfg = {
        autoDetectarEndereco: document.getElementById('cfgAutoDetectar').checked,
        enviarLinkRastreamento: document.getElementById('cfgEnviarLink').checked,
        notificarTempoMotorista: document.getElementById('cfgNotificarTempo').checked,
        mensagemBoaViagem: document.getElementById('cfgBoaViagem').checked
    };
    await api('/api/rebeca/config', 'PUT', cfg);
    alert('âœ… ConfiguraÃ§Ãµes salvas!');
    carregarConfigRebeca();
}

async function testarRebeca() {
    const tel = document.getElementById('testeRebecaTel').value;
    const msg = document.getElementById('testeRebecaMsg').value;
    if (!msg) { alert('Digite uma mensagem'); return; }
    
    const r = await api('/api/rebeca/mensagem', 'POST', { telefone: tel, mensagem: msg, nome: 'Teste' });
    
    const div = document.getElementById('testeRebecaResposta');
    div.style.display = 'block';
    div.innerHTML = '<strong>Resposta da Rebeca:</strong>\n\n' + (r.resposta || r.error || 'Erro');
}
</script>

<script>
// ==================== PÃGINA IA ====================
const paginaIA = document.createElement('div');
paginaIA.id = 'ia';
paginaIA.className = 'page';
paginaIA.innerHTML = `
    <h2 style="margin-bottom:20px;">ğŸ¤– InteligÃªncia Artificial (Claude)</h2>
    
    <div class="cards">
        <div class="card" id="cardIAStatus"><h3>Status</h3><div class="value" id="iaStatus">-</div></div>
        <div class="card blue"><h3>Modelo</h3><div class="value" id="iaModelo">-</div></div>
        <div class="card green"><h3>RequisiÃ§Ãµes Hoje</h3><div class="value" id="iaRequisicoes">0</div></div>
    </div>

    <div class="panel">
        <h2>ğŸ”‘ Configurar API Key</h2>
        <p style="color:#666;margin-bottom:15px;">Obtenha sua API Key em <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></p>
        
        <div class="form-group">
            <label>API Key da Anthropic</label>
            <input type="password" id="iaApiKey" placeholder="sk-ant-api03-..." style="font-family:monospace;">
        </div>
        
        <div class="form-group">
            <label>Modelo</label>
            <select id="iaModeloSelect">
                <option value="claude-3-haiku-20240307">Claude 3 Haiku (RÃ¡pido e Barato)</option>
                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (Equilibrado)</option>
                <option value="claude-3-opus-20240229">Claude 3 Opus (Mais Inteligente)</option>
            </select>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn btn-success" onclick="salvarConfigIA()">ğŸ’¾ Salvar</button>
            <button class="btn btn-primary" onclick="testarIA()">ğŸ§ª Testar ConexÃ£o</button>
        </div>
        
        <div id="iaTesteResultado" style="margin-top:15px;padding:15px;border-radius:10px;display:none;"></div>
    </div>

    <div class="panel">
        <h2>ğŸ§ª Testar IA</h2>
        <p style="color:#666;margin-bottom:15px;">Simule mensagens para ver como a IA interpreta.</p>
        
        <div class="form-group">
            <label>Mensagem de Teste</label>
            <input type="text" id="iaTesteMensagem" placeholder="Ex: preciso ir pro shopping agora">
        </div>
        
        <button class="btn btn-primary" onclick="testarAnaliseIA()">ğŸ” Analisar Mensagem</button>
        
        <div id="iaAnaliseResultado" style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:10px;display:none;white-space:pre-wrap;font-family:monospace;font-size:0.85em;"></div>
    </div>

    <div class="panel">
        <h2>ğŸ’¡ Como Funciona</h2>
        <div style="background:#e8f5e9;padding:15px;border-radius:10px;">
            <p><strong>Com IA ATIVA, a Rebeca entende:</strong></p>
            <ul style="margin:10px 0 0 20px;">
                <li>"preciso ir pro shopping" â†’ Pedir corrida</li>
                <li>"me busca na padaria do JoÃ£o" â†’ Extrai endereÃ§o</li>
                <li>"quanto fica atÃ© o aeroporto?" â†’ CotaÃ§Ã£o</li>
                <li>"tÃ´ na casa azul perto do mercado" â†’ EndereÃ§o + ReferÃªncia</li>
                <li>"chama um carro pra minha mÃ£e" â†’ Entende contexto</li>
            </ul>
            <p style="margin-top:15px;"><strong>Sem IA:</strong> Funciona com palavras-chave (1, 2, 3, menu, etc.)</p>
        </div>
    </div>

    <div class="panel">
        <h2>ğŸ’° Custos Estimados</h2>
        <table style="width:100%;">
            <thead><tr><th>Modelo</th><th>Custo/1K msgs</th><th>Velocidade</th><th>InteligÃªncia</th></tr></thead>
            <tbody>
                <tr><td>Haiku</td><td>~$0.25</td><td>âš¡âš¡âš¡ Muito RÃ¡pido</td><td>â­â­â­</td></tr>
                <tr><td>Sonnet</td><td>~$3.00</td><td>âš¡âš¡ RÃ¡pido</td><td>â­â­â­â­</td></tr>
                <tr><td>Opus</td><td>~$15.00</td><td>âš¡ Normal</td><td>â­â­â­â­â­</td></tr>
            </tbody>
        </table>
        <p style="color:#666;margin-top:10px;font-size:0.9em;">ğŸ’¡ Recomendamos <strong>Haiku</strong> para a maioria dos casos.</p>
    </div>
`;
document.querySelector('.main-content').appendChild(paginaIA);

// Menu IA
const menuIA = document.createElement('div');
menuIA.className = 'menu-item';
menuIA.setAttribute('data-page', 'ia');
menuIA.innerHTML = 'ğŸ¤– InteligÃªncia Artificial';
document.querySelector('.sidebar').insertBefore(menuIA, document.querySelector('[data-page="config"]'));

menuIA.addEventListener('click', () => {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    menuIA.classList.add('active');
    document.getElementById('ia').classList.add('active');
    carregarConfigIA();
});

async function carregarConfigIA() {
    const cfg = await api('/api/ia/config');
    document.getElementById('iaStatus').textContent = cfg.ativo ? 'ğŸŸ¢ ATIVA' : 'ğŸ”´ Desativada';
    document.getElementById('cardIAStatus').className = 'card ' + (cfg.ativo ? 'green' : 'red');
    document.getElementById('iaModelo').textContent = cfg.modelo?.split('-')[1] || '-';
    if (cfg.modelo) document.getElementById('iaModeloSelect').value = cfg.modelo;
}

async function salvarConfigIA() {
    const apiKey = document.getElementById('iaApiKey').value.trim();
    const modelo = document.getElementById('iaModeloSelect').value;
    
    const r = await api('/api/ia/config', 'PUT', { apiKey, modelo, ativo: !!apiKey });
    
    if (r.sucesso) {
        alert('âœ… ConfiguraÃ§Ã£o salva!');
        carregarConfigIA();
    } else {
        alert('âŒ Erro: ' + (r.error || 'Falha ao salvar'));
    }
}

async function testarIA() {
    const div = document.getElementById('iaTesteResultado');
    div.style.display = 'block';
    div.style.background = '#fff3cd';
    div.innerHTML = 'â³ Testando conexÃ£o...';
    
    const r = await api('/api/ia/testar', 'POST');
    
    if (r.sucesso) {
        div.style.background = '#d4edda';
        div.innerHTML = 'âœ… <strong>ConexÃ£o OK!</strong><br>Modelo: ' + r.modelo + '<br>Resposta: ' + r.resposta;
    } else {
        div.style.background = '#f8d7da';
        div.innerHTML = 'âŒ <strong>Erro:</strong> ' + (r.erro || 'Falha na conexÃ£o');
    }
}

async function testarAnaliseIA() {
    const msg = document.getElementById('iaTesteMensagem').value;
    if (!msg) { alert('Digite uma mensagem'); return; }
    
    const div = document.getElementById('iaAnaliseResultado');
    div.style.display = 'block';
    div.innerHTML = 'â³ Analisando...';
    
    const r = await api('/api/ia/analisar', 'POST', { mensagem: msg, contexto: { nome: 'Teste' } });
    
    div.innerHTML = '<strong>AnÃ¡lise da IA:</strong>\n\n' + JSON.stringify(r, null, 2);
}

    // ==================== WHATSAPP REBECA ====================
    let adminInstanciaId = null;
    let verificarWppInterval = null;
    
    async function carregarWhatsAppAdmin() {
        try {
            // Buscar instancia do admin atual
            const usuario = JSON.parse(localStorage.getItem('usuario') || '{}'); const adminId = usuario._id || usuario.id; if (!adminId) { alert('SessÃ£o expirada!'); window.location.href = '/admin/login.html'; return; } if (!adminId) { alert('SessÃ£o expirada!'); window.location.href = '/admin/login.html'; return; }
            const res = await fetch('/api/evolution/instancias/admin/' + adminId);
            const data = await res.json();
            
            if (data.sucesso && data.instancias && data.instancias.length > 0) {
                const inst = data.instancias[0];
                adminInstanciaId = inst._id;
                atualizarStatusWhatsApp(inst.status);
                
                if (inst.status === 'conectado') {
                    document.getElementById('btnGerarQR').style.display = 'none';
                    document.getElementById('btnDesconectar').style.display = 'inline-block';
                }
            }
            
            // Carregar total de motoristas
            const motRes = await fetch('/api/motoristas');
            const motoristas = await motRes.json();
            document.getElementById('wppMotoristas').textContent = Array.isArray(motoristas) ? motoristas.length : 0;
        } catch (e) {
            console.log('Erro ao carregar WhatsApp:', e);
        }
    }
    
    function atualizarStatusWhatsApp(status) {
        const badge = document.getElementById('wppStatusBadge');
        const text = document.getElementById('wppStatusText');
        const card = document.getElementById('cardStatusWpp');
        
        if (status === 'conectado') {
            badge.style.background = '#d4edda';
            badge.style.color = '#155724';
            badge.innerHTML = 'ğŸŸ¢ Conectado - Rebeca Ativa';
            text.textContent = 'Conectado';
            card.className = 'card green';
        } else if (status === 'conectando') {
            badge.style.background = '#fff3cd';
            badge.style.color = '#856404';
            badge.innerHTML = 'ğŸŸ¡ Aguardando escaneamento...';
            text.textContent = 'Conectando';
            card.className = 'card orange';
        } else {
            badge.style.background = '#f8d7da';
            badge.style.color = '#721c24';
            badge.innerHTML = 'ğŸ”´ Desconectado';
            text.textContent = 'Desconectado';
            card.className = 'card red';
        }
    }
    
    async function gerarQRCodeAdmin() {
        const qrBox = document.getElementById('qrCodeBox');
        qrBox.innerHTML = '<div style="border:4px solid #ddd;border-top:4px solid #27ae60;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;"></div><p style="color:#333;margin-top:15px;">Gerando QR Code...</p>';
        document.getElementById('btnGerarQR').disabled = true;
        
        try {
            // Se nao tem instancia, criar uma
            if (!adminInstanciaId) {
                const usuario = JSON.parse(localStorage.getItem('usuario') || '{}'); const adminId = usuario._id || usuario.id;
                const empresa = usuario.nome || usuario.login || 'empresa';
                
                const createRes = await fetch('/api/evolution/instancia', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId: adminId, nomeEmpresa: empresa })
                });
                const createData = await createRes.json();
                
                if (createData.sucesso) {
                    adminInstanciaId = createData.instancia._id;
                } else {
                    qrBox.innerHTML = '<p style="color:#c0392b;">Erro: ' + (createData.erro || 'Falha ao criar instancia') + '</p>';
                    document.getElementById('btnGerarQR').disabled = false;
                    return;
                }
            }
            
            // Gerar QR Code
            const res = await fetch('/api/evolution/instancia/' + adminInstanciaId + '/qrcode');
            const data = await res.json();
            
            if (data.sucesso && data.qrCode) {
                if (data.qrCode.startsWith('data:image')) {
                    qrBox.innerHTML = '<img src="' + data.qrCode + '" style="max-width:250px;border-radius:10px;">';
                } else {
                    qrBox.innerHTML = '<div style="background:#f8f9fa;padding:20px;border-radius:10px;"><p style="color:#333;font-size:12px;word-break:break-all;">' + data.qrCode + '</p><p style="color:#666;font-size:11px;margin-top:10px;">Configure a Evolution API para QR visual</p></div>';
                }
                
                atualizarStatusWhatsApp('conectando');
                
                // Iniciar verificacao
                if (verificarWppInterval) clearInterval(verificarWppInterval);
                verificarWppInterval = setInterval(verificarStatusWpp, 3000);
            } else {
                qrBox.innerHTML = '<p style="color:#c0392b;">Erro: ' + (data.erro || 'Falha ao gerar QR') + '</p>';
            }
        } catch (e) {
            qrBox.innerHTML = '<p style="color:#c0392b;">Erro de conexao</p>';
        }
        
        document.getElementById('btnGerarQR').disabled = false;
    }
    
    async function verificarStatusWpp() {
        if (!adminInstanciaId) return;
        
        try {
            const res = await fetch('/api/evolution/instancia/' + adminInstanciaId + '/status');
            const data = await res.json();
            
            if (data.sucesso) {
                atualizarStatusWhatsApp(data.status);
                
                if (data.status === 'conectado') {
                    clearInterval(verificarWppInterval);
                    document.getElementById('qrCodeBox').innerHTML = '<div style="text-align:center;"><p style="color:#27ae60;font-size:48px;">âœ…</p><h3 style="color:#27ae60;">WhatsApp Conectado!</h3><p style="color:#666;margin-top:10px;">A Rebeca ja esta atendendo seus clientes</p></div>';
                    document.getElementById('btnGerarQR').style.display = 'none';
                    document.getElementById('btnDesconectar').style.display = 'inline-block';
                }
            }
        } catch (e) {}
    }
    
    async function desconectarWhatsApp() {
        if (!confirm('Deseja desconectar o WhatsApp? A Rebeca parara de atender.')) return;
        
        try {
            await fetch('/api/evolution/instancia/' + adminInstanciaId + '/desconectar', { method: 'POST' });
            adminInstanciaId = null;
            document.getElementById('qrCodeBox').innerHTML = '<p style="color:#333;">Clique no botao abaixo para gerar o QR Code</p>';
            atualizarStatusWhatsApp('desconectado');
            document.getElementById('btnGerarQR').style.display = 'inline-block';
            document.getElementById('btnDesconectar').style.display = 'none';
        } catch (e) {
            alert('Erro ao desconectar');
        }
    }
    
    // Adicionar estilo de animacao
    if (!document.getElementById('spinStyle')) {
        const style = document.createElement('style');
        style.id = 'spinStyle';
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    }
    
    // Carregar ao abrir pagina WhatsApp
    const origShowPage = window.showPage;
    window.showPage = function(page) {
        if (typeof origShowPage === 'function') origShowPage(page);
        if (page === 'whatsapp') carregarWhatsAppAdmin();
    };


    </script>
